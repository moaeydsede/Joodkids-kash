<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#111827" />
  <title>VIP Cashbook</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/icons/icon-192.png">
  <style>
    :root{
      --bg:#0a0f1f;
      --card:#0f172a;
      --card2:#0b1226;
      --text:#e5e7eb;
      --muted:#9aa6bf;
      --line:rgba(148,163,184,.16);
      --primary:#16a34a; /* emerald */
      --danger:#dc2626;
      --warn:#d97706;
      --info:#2563eb;
      --shadow: 0 14px 34px rgba(0,0,0,.45);
      --radius:18px;
      --tap: 54px;
      --font: system-ui, -apple-system, "Cairo", "Segoe UI", Roboto, Arial, sans-serif;
    
      --bg:#0b1020;
      --card:#0f172a;
      --card2:#111c35;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(148,163,184,.18);
      --primary:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --info:#60a5fa;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --tap: 54px;
      --font: system-ui, -apple-system, "Cairo", "Segoe UI", Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{
      overflow-x:hidden;height:100%}
    body{
      overflow-x:hidden;
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 900px at 20% -10%, rgba(34,197,94,.14), transparent 45%),
                  radial-gradient(900px 600px at 110% 0%, rgba(96,165,250,.12), transparent 40%),
                  radial-gradient(900px 700px at 30% 120%, rgba(245,158,11,.10), transparent 40%),
                  var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
    }
    a{color:inherit}
    .app{
      max-width: 980px;
      margin: 0 auto;
      min-height: 100%;
      display:flex;
      flex-direction:column;
    }
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(11,16,32,.82);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
      padding: 14px 14px calc(14px + env(safe-area-inset-top));
    }
    .topbar-inner{
      display:flex; align-items:center; gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.2px;
      user-select:none;
      flex:1;
    }
    .brand .logo{
      width:38px;height:38px;border-radius:14px;
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(96,165,250,.85));
      box-shadow: 0 14px 30px rgba(34,197,94,.15);
      display:grid; place-items:center;
      font-weight:900;
      color:#0b1020;
    }
    .pill{
      font-size:12px;
      color: var(--muted);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .pill b{color:var(--text); font-weight:800}
    .nav{
      display:flex; gap:8px; margin-top: 12px;
      overflow:auto;
      padding-bottom: 2px;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(15,23,42,.6);
      color: var(--muted);
      border-radius: 999px;
      padding: 10px 14px;
      min-height: 44px;
      display:flex; align-items:center; gap:8px;
      cursor:pointer;
      user-select:none;
      transition: .15s transform ease, .15s background ease, .15s color ease;
      white-space:nowrap;
      font-weight:700;
    }
    .tab:active{transform: scale(.98)}
    .tab.active{
      background: rgba(34,197,94,.15);
      border-color: rgba(34,197,94,.45);
      color: var(--text);
    }
    .content{
      padding: 14px;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
      flex:1;
    }
    .grid{
      display:grid;
      gap:12px;
    }
    @media (min-width: 860px){
      .grid.two{grid-template-columns:1fr 1fr}
      .grid.three{grid-template-columns:1fr 1fr 1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(15,23,42,.88), rgba(15,23,42,.62));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .sub{
      color:var(--muted);
      font-size: 13px;
      line-height:1.45;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row.between{justify-content:space-between}
    .btn{
      border:1px solid var(--line);
      background: rgba(17,28,53,.7);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 14px;
      min-height: var(--tap);
      cursor:pointer;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      transition: .15s transform ease, .15s background ease, .15s border-color ease, .15s opacity ease;
    }
    .btn:active{transform: scale(.985)}
    .btn.primary{
      background: rgba(34,197,94,.16);
      border-color: rgba(34,197,94,.5);
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.45);
    }
    .btn.ghost{
      background: transparent;
    }
    .btn.small{
      padding: 10px 12px;
      min-height: 44px;
      border-radius: 12px;
      font-weight:800;
      font-size: 13px;
    }
    .btn.wide{width:100%}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(17,28,53,.45);
      color:var(--text);
      border-radius: 14px;
      padding: 14px 14px;
      min-height: var(--tap);
      outline:none;
      font-size: 16px; /* big like WhatsApp */
    }
    textarea{min-height: 90px; resize: vertical}
    .label{font-size:13px;color:var(--muted);margin:0 0 6px 2px}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .kpi{
      display:flex; flex-direction:column; gap:6px;
      padding: 14px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(17,28,53,.45);
    }
    .kpi .t{color:var(--muted); font-size:12px}
    .kpi .v{font-size: 20px; font-weight:900; letter-spacing:.2px}
    .kpi .v small{font-size:13px; color:var(--muted); font-weight:800}
    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      border:1px solid var(--line);
      background: rgba(17,28,53,.45);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .item .meta{display:flex; flex-direction:column; gap:4px}
    .item .meta .title{font-weight:900}
    .item .meta .small{font-size:12px;color:var(--muted); line-height:1.35}
    .tag{
      font-size:12px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      color: var(--muted);
      white-space:nowrap;
      font-weight:800;
    }
    .tag.in{border-color: rgba(34,197,94,.45); color: rgba(167,243,208,.95); background: rgba(34,197,94,.08)}
    .tag.out{border-color: rgba(239,68,68,.45); color: rgba(254,202,202,.95); background: rgba(239,68,68,.08)}
    .tag.note{border-color: rgba(96,165,250,.45); color: rgba(191,219,254,.95); background: rgba(96,165,250,.08)}
    .toast{
      position:fixed;
      inset:auto 12px 12px 12px;
      z-index: 1000;
      display:none;
    }
    .toast.show{display:block}
    .toast .box{
      max-width: 980px;
      margin: 0 auto;
      border:1px solid var(--line);
      background: rgba(15,23,42,.92);
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .toast .msg{font-weight:800}
    .toast .hint{color:var(--muted);font-size:12px;margin-top:2px}
    .modal{
      position:fixed; inset:0; z-index:2000;
      background: rgba(0,0,0,.5);
      display:none;
      padding: 14px;
    }
    .modal.show{display:grid; place-items:center}
    .modal .panel{
      width:min(560px, 100%);
      background: rgba(11,16,32,.95);
      border:1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .modal .panel h3{margin:0 0 8px 0}
    .hintbox{
      border:1px dashed rgba(148,163,184,.35);
      border-radius: 16px;
      padding: 12px;
      background: rgba(17,28,53,.30);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .center{display:grid; place-items:center}
    .login-wrap{max-width: 520px; margin: 26px auto}
    .big-title{font-size: 20px; font-weight: 900; margin: 0 0 6px 0}
    .small-title{font-size: 13px; color: var(--muted); margin:0 0 14px 0; line-height:1.5}
    .footer{
      color: rgba(148,163,184,.9);
      font-size: 12px;
      text-align:center;
      padding: 22px 10px 14px 10px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(17,28,53,.35);
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }
    .right{margin-inline-start:auto}
    .hide{display:none !important}
    .danger-text{color: rgba(254,202,202,.95)}

    /* PRO LAYOUT TWEAKS */
    #kpis{grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); overflow:hidden; padding-bottom:0}
    .quick-actions{display:flex; gap:10px}
    .quick-actions .btn{flex:1; min-width:0}
    /* Quick buttons in notes card side-by-side */
    .quick-actions .btn{flex:1; min-width:0}

    .ok-text{color: rgba(167,243,208,.95)}
    .warn-text{color: rgba(253,230,138,.95)}
  
    /* CLEAN MODE: hide notes/hints */
    .hintbox{display:none !important}
    .sub{display:none !important}
    </style>
    
</head>
<body>
<div class="app">

  <div class="topbar" id="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">V</div>
        <div>
          <div style="font-size:15px;">VIP Cashbook</div>
          <div class="sub" id="subtitle">Mobile App (PWA)</div>
        </div>
      </div>
      <div class="pill" id="userPill" style="display:none">
        <span>ğŸ‘¤</span>
        <b id="userName">admin</b>
        <span class="muted" id="userRole">ADMIN</span>
      </div>
      <button class="btn small ghost" id="logoutBtn" style="display:none" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">Ø®Ø±ÙˆØ¬</button>
    </div>
    <div class="nav" id="nav" style="display:none">
      <div class="tab active" data-view="balances">Ø§Ù„Ø£Ø±ØµØ¯Ø©</div>
      <div class="tab" data-view="transactions">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
      <div class="tab" data-view="accounts">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
      <div class="tab" data-view="users" id="usersTab">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
      <div class="tab" data-view="import">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</div>
      <div class="tab" data-view="settings" id="settingsTab">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>
  </div>

  <div class="content" id="content">

    <!-- LOGIN -->
    <section id="view-login" class="login-wrap">
      <div class="card">
        <div class="row between">
          <div>
            <div class="big-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
            <div class="small-title">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª â€” ØªØµÙ…ÙŠÙ… Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙƒØ¨ÙŠØ± ÙˆÙˆØ§Ø¶Ø­.</div>
          </div>
          <span class="badge">Offline + LocalStorage</span>
        </div>

        <div class="sep"></div>

        <div class="grid">
          <div>
            <div class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
            <input class="input" id="loginUser" placeholder="admin" autocomplete="username" />
          </div>
          <div>
            <div class="label">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</div>
            <input class="input" id="loginPass" type="password" placeholder="12345" autocomplete="current-password" />
          </div>
          <button class="btn primary wide" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>

          <div class="hintbox">
            <div><b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:</b></div>
            <div class="mono">Username: admin</div>
            <div class="mono">Password: 12345</div>
            <div class="muted">ØªÙ‚Ø¨Ù„ Ø£ÙŠØ¶Ù‹Ø§: Ù¡Ù¢Ù£Ù¤Ù¥</div>
          </div>
        </div>
      </div>

      <div class="footer">VIP Cashbook â€“ PWA â€¢ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
    </section>

    <!-- BALANCES -->
    <section id="view-balances" class="hide">
      <div class="grid two">
        <div class="card">
          <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø±ØµØ¯Ø©</h2>
          <div class="sub">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯ Ù„ÙƒÙ„ Ø­Ø³Ø§Ø¨ (Ø­Ø³Ø§Ø¨/Ù…Ø­ÙØ¸Ø©/ØµÙ†Ø¯ÙˆÙ‚).</div>
          <div class="sep"></div>
          <div class="grid three" id="kpis"></div>
        </div>

        <div class="card">
          <h2>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h2>
          <div class="hintbox">
            <div>â€¢ Ø§Ù„Ø£Ø±ØµØ¯Ø© ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ù‚Ø¨Ø¶/ØµØ±Ù).</div>
            <div>â€¢ Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©: Ø§ÙØªØ­ ØµÙØ­Ø© <b>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</b> Ø«Ù… <b>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</b>.</div>
            <div>â€¢ Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯: ØµÙØ­Ø© <b>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</b>.</div>
            <div>â€¢ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel Ù…ØªØ§Ø­ Ù…Ù† ØµÙØ­Ø© <b>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</b>.</div>
          </div>
          <div class="sep"></div>
          <div class="row quick-actions">
            <button class="btn primary" onclick="openAddTx()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</button>
            <button class="btn" onclick="printBalances()">ğŸ“„ PDF Ø§Ù„Ø£Ø±ØµØ¯Ø©</button>
            <button class="btn" onclick="switchView('transactions')">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="row between">
          <h2 style="margin:0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø±ØµØ¯Ø©</h2>
          <span class="badge" id="balancesCount">0 Ø­Ø³Ø§Ø¨</span>
        </div>
        <div class="sep"></div>
        <div class="list" id="balancesList"></div>
      </div>
    </section>

    <!-- TRANSACTIONS -->
    <section id="view-transactions" class="hide">
      <div class="card">
        <div class="row between">
          <div>
            <h2 style="margin:0 0 6px 0">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
            <div class="sub">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨/Ø§Ù„ØªØ§Ø±ÙŠØ® + Ø¨Ø­Ø«. Ø¹Ø±Ø¶ ÙƒØ¨Ø·Ø§Ù‚Ø§Øª Ù…ÙˆØ¨Ø§ÙŠÙ„.</div>
          </div>
          <div class="row">
            <button class="btn primary" onclick="openAddTx()">â• Ø¥Ø¶Ø§ÙØ©</button>
            <button class="btn" onclick="printTransactions()">ğŸ“„ PDF Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
            <button class="btn" onclick="exportJson()">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid two">
          <div>
            <div class="label">Ø§Ù„Ø­Ø³Ø§Ø¨</div>
            <select id="fAccount"></select>
          </div>
          <div>
            <div class="label">Ø¨Ø­Ø«</div>
            <input class="input" id="fSearch" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØµÙ/Ø§Ù„Ù…Ø±Ø¬Ø¹/Ø§Ù„Ù…Ø¨Ù„Øº..." />
          </div>
          <div>
            <div class="label">Ù…Ù† ØªØ§Ø±ÙŠØ®</div>
            <input class="input" id="fFrom" type="date" />
          </div>
          <div>
            <div class="label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</div>
            <input class="input" id="fTo" type="date" />
          </div>
        </div>

        
        <div class="grid three" id="txSummary" style="margin-top:12px">
          <div class="kpi"><div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª</div><div class="v" id="sumIn">0 <small>Ø¬.Ù…</small></div></div>
          <div class="kpi"><div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div><div class="v" id="sumOut">0 <small>Ø¬.Ù…</small></div></div>
          <div class="kpi"><div class="t">Ø§Ù„Ø±ØµÙŠØ¯ (ØµØ§ÙÙŠ)</div><div class="v" id="sumNet">0 <small>Ø¬.Ù…</small></div></div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" onclick="resetFilters()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
          <button class="btn" onclick="renderTransactions()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
          <span class="badge right" id="txCount">0 Ø¹Ù…Ù„ÙŠØ©</span>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="list" id="txList"></div>
    </section>

    <!-- ACCOUNTS -->
    <section id="view-accounts" class="hide">
      <div class="card">
        <div class="row between">
          <div>
            <h2 style="margin:0 0 6px 0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
            <div class="sub">Ø£Ø¶Ù ØµÙ†Ø¯ÙˆÙ‚/Ù…Ø­ÙØ¸Ø©/Ø­Ø³Ø§Ø¨. ÙŠÙ…ÙƒÙ† ØªØ¹Ø·ÙŠÙ„/Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù…Ù„ÙŠØ§Øª.</div>
          </div>
          <button class="btn primary" onclick="openAddAccount()">â• Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        </div>
        <div class="sep"></div>
        <div class="list" id="accountsList"></div>
      </div>
    </section>

    <!-- USERS -->
    <section id="view-users" class="hide">
      <div class="card">
        <div class="row between">
          <div>
            <h2 style="margin:0 0 6px 0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            <div class="sub">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·. Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø·ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</div>
          </div>
          <button class="btn primary" id="addUserBtn" onclick="openAddUser()">â• Ù…Ø³ØªØ®Ø¯Ù…</button>
        </div>
        <div class="sep"></div>
        <div class="list" id="usersList"></div>
      </div>
    </section>

    <!-- IMPORT -->
    <section id="view-import" class="hide">
      <div class="card">
        <h2>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</h2>
        <div class="sub">ÙŠØ¯Ø¹Ù… Ù…Ù„ÙØ§Øª .xlsx Ø¹Ø¨Ø± XLSX.js. Ø³ÙŠØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª/Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</div>
        <div class="sep"></div>

        <div class="grid two">
          <div>
            <div class="label">Ù…Ù„Ù Excel</div>
            <input class="input" id="xlsxFile" type="file" accept=".xlsx,.xls" />
          </div>
          <div>
            <div class="label">ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ (Sheet)</div>
            <select id="xlsxSheet">
              <option value="">â€” Ø§Ø®ØªØ± Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù â€”</option>
            </select>
          </div>
        </div>

        
        <div class="grid three" id="txSummary" style="margin-top:12px">
          <div class="kpi"><div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª</div><div class="v" id="sumIn">0 <small>Ø¬.Ù…</small></div></div>
          <div class="kpi"><div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div><div class="v" id="sumOut">0 <small>Ø¬.Ù…</small></div></div>
          <div class="kpi"><div class="t">Ø§Ù„Ø±ØµÙŠØ¯ (ØµØ§ÙÙŠ)</div><div class="v" id="sumNet">0 <small>Ø¬.Ù…</small></div></div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="importBtn" disabled>â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
          <button class="btn" onclick="downloadTemplate()">â¬‡ï¸ Ù‚Ø§Ù„Ø¨ Excel</button>
          <span class="badge right" id="importInfo">Ø¬Ø§Ù‡Ø²</span>
        </div>

        <div class="sep"></div>
        <div class="hintbox">
          <div><b>Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ):</b></div>
          <div class="mono" style="margin-top:6px; direction:ltr; text-align:left;">
            date | account | type | amount | note | ref
          </div>
          <div class="muted" style="margin-top:6px;">
            â€¢ type: IN Ø£Ùˆ OUT (Ø£Ùˆ Ù‚Ø¨Ø¶/ØµØ±Ù)<br>
            â€¢ date: Ø¨ØµÙŠØºØ© yyyy-mm-dd Ø£Ùˆ ØªØ§Ø±ÙŠØ® Excel Ø¹Ø§Ø¯ÙŠ
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="view-settings" class="hide">
      <div class="grid two">
        <div class="card">
          <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
          <div class="sub">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ / Ø§Ø³ØªØ¹Ø§Ø¯Ø© / Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>
          <div class="sep"></div>
          <div class="row" style="width:100%">
            <button class="btn" onclick="backupDownload()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
            <label class="btn" style="cursor:pointer">
              â¬†ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©
              <input id="restoreFile" type="file" accept=".json" class="hide">
            </label>
          </div>
          <div style="height:10px"></div>
          <button class="btn danger wide" onclick="confirmWipe()">ğŸ§¨ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

          <div class="sep"></div>
          <div class="hintbox">
            <div><b>Ù…Ù‡Ù…:</b> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø². Ø¹Ù†Ø¯ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ø£Ùˆ ØªØºÙŠÙŠØ± Ø§Ù„Ø¬Ù‡Ø§Ø² Ø³ØªÙÙ‚Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>
          </div>
        </div>

        <div class="card">
          <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h2>
          <div class="hintbox">
            <div>â€¢ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Service Worker Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙƒØ§Ø´.</div>
            <div>â€¢ ÙŠØ¹Ù…Ù„ Offline Ø¬Ø²Ø¦ÙŠÙ‹Ø§ (LocalStorage).</div>
            <div>â€¢ Ù…Ù†Ø§Ø³Ø¨ 100% Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Ø£Ø²Ø±Ø§Ø± ÙƒØ¨ÙŠØ±Ø© Ù…Ø«Ù„ ÙˆØ§ØªØ³Ø§Ø¨).</div>
          </div>
          <div class="sep"></div>
          <div class="row">
            <span class="badge">Version <span id="ver">1.0.0</span></span>
            <span class="badge">RTL</span>
            <span class="badge">PWA</span>
          </div>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- MODALS -->
<div class="modal" id="modal">
  <div class="panel">
    <div class="row between">
      <h3 id="modalTitle" style="margin:0">â€”</h3>
      <button class="btn small ghost" onclick="closeModal()">âœ•</button>
    </div>
    <div class="sep"></div>
    <div id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="box">
    <div>
      <div class="msg" id="toastMsg">ØªÙ…</div>
      <div class="hint" id="toastHint"></div>
    </div>
    <button class="btn small" onclick="hideToast()">Ø­Ø³Ù†Ø§Ù‹</button>
  </div>
</div>

<!-- XLSX (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* =============================
   VIP Cashbook â€“ Single File App
   Data stored in LocalStorage
   ============================= */

const APP_KEY = "vip_cashbook_v1";
const VERSION = "1.0.0";
document.getElementById("ver").textContent = VERSION;

// Arabic digits -> English digits
function normalizeDigits(str){
  if(str == null) return "";
  const map = {"Ù ":"0","Ù¡":"1","Ù¢":"2","Ù£":"3","Ù¤":"4","Ù¥":"5","Ù¦":"6","Ù§":"7","Ù¨":"8","Ù©":"9","Û°":"0","Û±":"1","Û²":"2","Û³":"3","Û´":"4","Ûµ":"5","Û¶":"6","Û·":"7","Û¸":"8","Û¹":"9"};
  return String(str).replace(/[Ù -Ù©Û°-Û¹]/g, d => map[d] ?? d).trim();
}
function nowISO(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
}
function money(n){
  const x = Number(n || 0);
  // format for ar-EG but keep digits Arabic locale
  try{
    return x.toLocaleString("ar-EG", {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }catch{
    return x.toFixed(2);
  }
}
function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

/* ======= STORAGE ======= */
function defaultDB(){
  return {
    meta: { version: VERSION, createdAt: new Date().toISOString() },
    session: { userId: null },
    users: [
      { id:"u_admin", username:"admin", pass:"12345", role:"ADMIN", active:true, createdAt: new Date().toISOString() }
    ],
    accounts: [
      { id:"a_cash", name:"Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚", kind:"CASH", active:true, createdAt: new Date().toISOString() },
      { id:"a_voda", name:"ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´", kind:"WALLET", active:true, createdAt: new Date().toISOString() },
      { id:"a_insta", name:"Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ", kind:"ACCOUNT", active:true, createdAt: new Date().toISOString() }
    ],
    tx: [
      // example
      { id: uid("tx"), date: nowISO(), accountId:"a_cash", type:"IN", amount: 0, note:"", ref:"", createdAt: new Date().toISOString() }
    ]
  };
}
function loadDB(){
  try{
    const raw = localStorage.getItem(APP_KEY);
    if(!raw) return defaultDB();
    const db = JSON.parse(raw);
    if(!db || !db.users || !db.accounts || !db.tx) return defaultDB();
    /* MIGRATE */
    for(const a of (db.accounts||[])) if(a.note === undefined) a.note = "";
    return db;
  }catch(e){
    console.warn(e);
    return defaultDB();
  }
}
function saveDB(){
  localStorage.setItem(APP_KEY, JSON.stringify(DB));
}
let DB = loadDB();

/* ======= AUTH ======= */
function currentUser(){
  const uid = DB.session?.userId;
  if(!uid) return null;
  return DB.users.find(u => u.id === uid && u.active) || null;
}
function isAdmin(){
  const u = currentUser();
  return u && u.role === "ADMIN";
}
function login(username, pass){
  const u = normalizeDigits(username).toLowerCase();
  const p = normalizeDigits(pass);
  const user = DB.users.find(x => x.active && x.username.toLowerCase() === u && normalizeDigits(x.pass) === p);
  if(!user) return {ok:false, error:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©"};
  DB.session.userId = user.id;
  saveDB();
  return {ok:true, user};
}
function logout(){
  DB.session.userId = null;
  saveDB();
  boot();
}

/* ======= UI NAV ======= */
const views = ["login","balances","transactions","accounts","users","import","settings"];
function switchView(name){
  if(!guardAdmin(name)) return;
  for(const v of views){
    const el = document.getElementById("view-"+v);
    if(el) el.classList.toggle("hide", v !== name);
  }
  document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.view === name));
  if(name === "balances") renderBalances();
  if(name === "transactions") { fillAccountFilter(); renderTransactions(); }
  if(name === "accounts") renderAccounts();
  if(name === "users") renderUsers();
  if(name === "import") prepareImportView();
}

document.getElementById("logoutBtn").addEventListener("click", logout);

document.getElementById("nav").addEventListener("click", (e)=>{
  const tab = e.target.closest(".tab");
  if(!tab) return;
  const view = tab.dataset.view;
  if(view === "users" && !isAdmin()){
    toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­", "ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·");
    return;
  }
  switchView(view);
});

/* ======= TOAST / MODAL ======= */
let toastTimer = null;
function toast(msg, hint=""){
  const t = document.getElementById("toast");
  document.getElementById("toastMsg").textContent = msg;
  document.getElementById("toastHint").textContent = hint;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove("show"), 3500);
}
function hideToast(){ document.getElementById("toast").classList.remove("show"); }

function openModal(title, bodyHTML){
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalBody").innerHTML = bodyHTML;
  document.getElementById("modal").classList.add("show");
}
function closeModal(){
  document.getElementById("modal").classList.remove("show");
}
document.getElementById("modal").addEventListener("click", (e)=>{
  if(e.target.id === "modal") closeModal();
});

/* ======= DATA HELPERS ======= */
function activeAccounts(){
  return DB.accounts.filter(a => a.active);
}
function accountById(id){
  return DB.accounts.find(a => a.id === id) || null;
}
function computeBalances(){
  const bal = {};
  for(const a of DB.accounts){
    bal[a.id] = 0;
  }
  for(const t of DB.tx){
    const amt = Number(t.amount || 0);
    if(!bal.hasOwnProperty(t.accountId)) bal[t.accountId] = 0;
    if(String(t.type).toUpperCase() === "IN") bal[t.accountId] += amt;
    else bal[t.accountId] -= amt;
  }
  return bal;
}
function txKindLabel(type){
  const up = String(type).toUpperCase();
  if(up === "IN") return "Ù‚Ø¨Ø¶";
  return "ØµØ±Ù";
}

/* ======= BALANCES VIEW ======= */
function renderBalances(){
  const bal = computeBalances();
  const kpis = document.getElementById("kpis");
  kpis.innerHTML = "";

  const accounts = activeAccounts();
  const total = accounts.reduce((s,a)=> s + (bal[a.id]||0), 0);

  const summary = [
    {t:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª", v: total, badge:"TOTAL"},
    {t:"Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª", v: accounts.length, badge:"ACCOUNTS"},
    {t:"Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«", v: new Date().toLocaleDateString("ar-EG"), badge:"NOW"}
  ];

  for(const s of summary){
    const div = document.createElement("div");
    div.className = "kpi";
    div.innerHTML = `
      <div class="t">${s.t}</div>
      <div class="v">${(s.badge==="ACCOUNTS")? s.v : (s.badge==="NOW")? '<small>'+s.v+'</small>' : money(s.v) + ' <small>Ø¬.Ù…</small>'}</div>
    `;
    kpis.appendChild(div);
  }

  const list = document.getElementById("balancesList");
  list.innerHTML = "";
  document.getElementById("balancesCount").textContent = accounts.length + " Ø­Ø³Ø§Ø¨";

  accounts
    .slice()
    .sort((a,b)=> (bal[b.id]||0) - (bal[a.id]||0))
    .forEach(a=>{
      const b = bal[a.id] || 0;
      const tag = a.kind === "CASH" ? "ØµÙ†Ø¯ÙˆÙ‚" : a.kind === "WALLET" ? "Ù…Ø­ÙØ¸Ø©" : "Ø­Ø³Ø§Ø¨";
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="meta">
          <div class="title">${escapeHtml(a.name)}</div>
          <div class="small">${tag} â€¢ ${a.active ? "Ù†Ø´Ø·" : "Ù…ÙˆÙ‚ÙˆÙ"}</div>
        </div>
        <div style="text-align:left; direction:ltr; display:flex; flex-direction:column; align-items:flex-start;">
          <div style="font-weight:900; font-size:16px">${money(b)} <span class="muted" style="font-weight:800">EGP</span></div>
          
        </div>
      `;
      list.appendChild(el);
    });
}

/* ======= TRANSACTIONS VIEW ======= */
function fillAccountFilter(){
  const sel = document.getElementById("fAccount");
  const old = sel.value;
  sel.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>` +
    activeAccounts().map(a => `<option value="${a.id}">${escapeHtml(a.name)}</option>`).join("");
  if(old) sel.value = old;
}
function resetFilters(){
  document.getElementById("fAccount").value = "";
  document.getElementById("fSearch").value = "";
  document.getElementById("fFrom").value = "";
  document.getElementById("fTo").value = "";
  renderTransactions();
}
function renderTransactions(){
  const a = document.getElementById("fAccount").value;
  const q = normalizeDigits(document.getElementById("fSearch").value).toLowerCase();
  const from = document.getElementById("fFrom").value;
  const to = document.getElementById("fTo").value;

  let rows = DB.tx.slice().filter(t=>{
    if(a && t.accountId !== a) return false;
    const d = String(t.date||"");
    if(from && d < from) return false;
    if(to && d > to) return false;
    if(q){
      const blob = [
        t.id, t.date, t.type, t.amount,
        accountById(t.accountId)?.name || "",
        t.note || "", t.ref || ""
      ].join(" ").toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });

  // totals for current filters
  let totalIn = 0, totalOut = 0;
  for(const t of rows){
    const amt = Number(t.amount || 0);
    if(String(t.type).toUpperCase() === "IN") totalIn += amt;
    else totalOut += amt;
  }
  const totalNet = totalIn - totalOut;
  const elIn = document.getElementById("sumIn");
  const elOut = document.getElementById("sumOut");
  const elNet = document.getElementById("sumNet");
  if(elIn) elIn.innerHTML = `${money(totalIn)} <small>Ø¬.Ù…</small>`;
  if(elOut) elOut.innerHTML = `${money(totalOut)} <small>Ø¬.Ù…</small>`;
  if(elNet) elNet.innerHTML = `${money(totalNet)} <small>Ø¬.Ù…</small>`;


  rows.sort((x,y)=> (y.date||"").localeCompare(x.date||"") || (y.createdAt||"").localeCompare(x.createdAt||""));

  document.getElementById("txCount").textContent = rows.length + " Ø¹Ù…Ù„ÙŠØ©";

  const list = document.getElementById("txList");
  list.innerHTML = "";

  if(rows.length === 0){
    const empty = document.createElement("div");
    empty.className = "card center";
    empty.innerHTML = `<div class="sub">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ±.</div>`;
    list.appendChild(empty);
    return;
  }

  for(const t of rows){
    const acc = accountById(t.accountId);
    const kind = String(t.type).toUpperCase()==="IN" ? "in" : "out";
    const tag = String(t.type).toUpperCase()==="IN" ? "Ù‚Ø¨Ø¶" : "ØµØ±Ù";
    const amount = Number(t.amount||0);
    const sign = kind==="in" ? "+" : "-";
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="meta">
        <div class="title">${escapeHtml(acc ? acc.name : "Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ")}</div>
        <div class="small">${escapeHtml(t.date||"")} â€¢ <span class="tag ${kind}">${tag}</span> ${t.ref ? `<span class="tag note"># ${escapeHtml(t.ref)}</span>` : ""}</div>
        ${t.note ? `<div class="small">${escapeHtml(t.note)}</div>` : ""}
      </div>
      <div style="text-align:left; direction:ltr; min-width:120px">
        <div style="font-weight:900; font-size:16px">${sign}${money(amount)} <span class="muted" style="font-weight:800">EGP</span></div>
        <div class="row" style="justify-content:flex-end; margin-top:8px; gap:8px">
          <button class="btn small" onclick="openEditTx('${t.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn small danger" onclick="deleteTx('${t.id}')">Ø­Ø°Ù</button>
        </div>
      </div>
    `;
    list.appendChild(el);
  }
}

/* ======= ACCOUNTS VIEW ======= */
function renderAccounts(){
  const list = document.getElementById("accountsList");
  list.innerHTML = "";
  const bal = computeBalances();

  const accounts = DB.accounts.slice().sort((a,b)=> (a.active===b.active? 0 : a.active? -1: 1));
  if(accounts.length === 0){
    list.innerHTML = `<div class="hintbox">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª.</div>`;
    return;
  }
  for(const a of accounts){
    const tag = a.kind === "CASH" ? "ØµÙ†Ø¯ÙˆÙ‚" : a.kind === "WALLET" ? "Ù…Ø­ÙØ¸Ø©" : "Ø­Ø³Ø§Ø¨";
    const used = DB.tx.some(t => t.accountId === a.id);
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="meta">
        <div class="title">${escapeHtml(a.name)} ${a.active? "" : `<span class="tag out">Ù…ÙˆÙ‚ÙˆÙ</span>`}</div>
        <div class="small">${tag} â€¢ Ø§Ù„Ø±ØµÙŠØ¯: <b>${money(bal[a.id]||0)}</b> Ø¬.Ù…</div>
        <div class="small muted">ID: ${a.id}</div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn small" onclick="openEditAccount('${a.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn small" onclick="toggleAccount('${a.id}')">${a.active? "Ø¥ÙŠÙ‚Ø§Ù" : "ØªÙØ¹ÙŠÙ„"}</button>
        <button class="btn small danger" ${used? "disabled title='Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø¨Ù‡ Ø¹Ù…Ù„ÙŠØ§Øª'":""} onclick="deleteAccount('${a.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    list.appendChild(el);
  }
}

/* ======= USERS VIEW ======= */
function renderUsers(){
  if(!isAdmin()){
    toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­", "Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·");
    switchView("balances");
    return;
  }
  const list = document.getElementById("usersList");
  list.innerHTML = "";
  const me = currentUser();

  for(const u of DB.users){
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="meta">
        <div class="title">${escapeHtml(u.username)} ${u.id===me.id? `<span class="tag note">Ø£Ù†Øª</span>`:""} ${u.active? "" : `<span class="tag out">Ù…ÙˆÙ‚ÙˆÙ</span>`}</div>
        <div class="small">${u.role} â€¢ ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(u.createdAt).toLocaleDateString("ar-EG")}</div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn small" onclick="openEditUser('${u.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn small" ${u.id===me.id? "disabled title='Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙŠÙ‚Ø§Ù Ù†ÙØ³Ùƒ'":""} onclick="toggleUser('${u.id}')">${u.active? "Ø¥ÙŠÙ‚Ø§Ù" : "ØªÙØ¹ÙŠÙ„"}</button>
      </div>
    `;
    list.appendChild(el);
  }
}

/* ======= MODALS: ADD/EDIT ======= */
function openAddTx(){
  const options = activeAccounts().map(a => `<option value="${a.id}">${escapeHtml(a.name)}</option>`).join("");
  openModal("Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©", `
    <div class="grid">
      <div>
        <div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
        <input class="input" id="tx_date" type="date" value="${nowISO()}">
      </div>
      <div>
        <div class="label">Ø§Ù„Ø­Ø³Ø§Ø¨</div>
        <select id="tx_account">${options}</select>
      </div>
      <div class="grid two">
        <div>
          <div class="label">Ø§Ù„Ù†ÙˆØ¹</div>
          <select id="tx_type">
            <option value="IN">Ù‚Ø¨Ø¶ (IN)</option>
            <option value="OUT">ØµØ±Ù (OUT)</option>
          </select>
        </div>
        <div>
          <div class="label">Ø§Ù„Ù…Ø¨Ù„Øº</div>
          <input class="input" id="tx_amount" inputmode="decimal" placeholder="0">
        </div>
      </div>
      <div class="grid two">
        <div>
          <div class="label">Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          <input class="input" id="tx_ref" placeholder="Ù…Ø«Ø§Ù„: ÙØ§ØªÙˆØ±Ø© 15">
        </div>
        <div>
          <div class="label">ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          <input class="input" id="tx_note" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¯Ø§Ø¯ / Ø´Ø±Ø§Ø¡ Ø®Ø§Ù…Ø§Øª ...">
        </div>
      </div>

      <button class="btn primary wide" onclick="addTx()">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
    </div>
  `);
}

function parseAmount(val){
  const s = normalizeDigits(val).replace(/[,ØŒ]/g,"").trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}
function addTx(){
  const date = document.getElementById("tx_date").value;
  const accountId = document.getElementById("tx_account").value;
  const type = document.getElementById("tx_type").value;
  const amount = parseAmount(document.getElementById("tx_amount").value);
  const ref = normalizeDigits(document.getElementById("tx_ref").value).trim();
  const note = normalizeDigits(document.getElementById("tx_note").value).trim();

  if(!date) return toast("Ø®Ø·Ø£", "Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®");
  if(!accountId) return toast("Ø®Ø·Ø£", "Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨");
  if(!Number.isFinite(amount) || amount <= 0) return toast("Ø®Ø·Ø£", "Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† 0");

  DB.tx.push({ id: uid("tx"), date, accountId, type: String(type).toUpperCase(), amount, ref, note, createdAt: new Date().toISOString() });
  saveDB();
  closeModal();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸", "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
  renderBalances();
  fillAccountFilter();
  renderTransactions();
}

function openEditTx(id){
  const t = DB.tx.find(x => x.id === id);
  if(!t) return toast("Ø®Ø·Ø£", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
  const options = activeAccounts().map(a => `<option value="${a.id}" ${a.id===t.accountId?"selected":""}>${escapeHtml(a.name)}</option>`).join("");
  openModal("ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ©", `
    <div class="grid">
      <div>
        <div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
        <input class="input" id="tx_date" type="date" value="${escapeAttr(t.date||"")}">
      </div>
      <div>
        <div class="label">Ø§Ù„Ø­Ø³Ø§Ø¨</div>
        <select id="tx_account">${options}</select>
      </div>
      <div class="grid two">
        <div>
          <div class="label">Ø§Ù„Ù†ÙˆØ¹</div>
          <select id="tx_type">
            <option value="IN" ${String(t.type).toUpperCase()==="IN"?"selected":""}>Ù‚Ø¨Ø¶ (IN)</option>
            <option value="OUT" ${String(t.type).toUpperCase()==="OUT"?"selected":""}>ØµØ±Ù (OUT)</option>
          </select>
        </div>
        <div>
          <div class="label">Ø§Ù„Ù…Ø¨Ù„Øº</div>
          <input class="input" id="tx_amount" inputmode="decimal" value="${escapeAttr(t.amount)}">
        </div>
      </div>
      <div class="grid two">
        <div>
          <div class="label">Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          <input class="input" id="tx_ref" value="${escapeAttr(t.ref||"")}">
        </div>
        <div>
          <div class="label">ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          <input class="input" id="tx_note" value="${escapeAttr(t.note||"")}">
        </div>
      </div>

      <button class="btn primary wide" onclick="saveEditTx('${id}')">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    </div>
  `);
}

function saveEditTx(id){
  const t = DB.tx.find(x => x.id === id);
  if(!t) return toast("Ø®Ø·Ø£", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");

  const date = document.getElementById("tx_date").value;
  const accountId = document.getElementById("tx_account").value;
  const type = document.getElementById("tx_type").value;
  const amount = parseAmount(document.getElementById("tx_amount").value);
  const ref = normalizeDigits(document.getElementById("tx_ref").value).trim();
  const note = normalizeDigits(document.getElementById("tx_note").value).trim();

  if(!date) return toast("Ø®Ø·Ø£", "Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®");
  if(!accountId) return toast("Ø®Ø·Ø£", "Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨");
  if(!Number.isFinite(amount) || amount <= 0) return toast("Ø®Ø·Ø£", "Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† 0");

  t.date = date;
  t.accountId = accountId;
  t.type = String(type).toUpperCase();
  t.amount = amount;
  t.ref = ref;
  t.note = note;
  saveDB();
  closeModal();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸", "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
  renderBalances();
  fillAccountFilter();
  renderTransactions();
}

function deleteTx(id){
  const t = DB.tx.find(x => x.id === id);
  if(!t) return;
  openModal("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù", `
    <div class="hintbox">
      Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.
      <div style="margin-top:10px" class="mono">ID: ${escapeHtml(id)}</div>
    </div>
    <div class="sep"></div>
    <div class="row">
      <button class="btn danger" onclick="confirmDeleteTx('${id}')">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
      <button class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `);
}
function confirmDeleteTx(id){
  DB.tx = DB.tx.filter(x => x.id !== id);
  saveDB();
  closeModal();
  toast("ØªÙ… Ø§Ù„Ø­Ø°Ù", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
  renderBalances();
  renderTransactions();
}

/* ======= ACCOUNTS MODALS ======= */
function openAddAccount(){
  openModal("Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨", `
    <div class="grid">
      <div>
        <div class="label">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</div>
        <input class="input" id="acc_name" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø²Ù†Ø© ÙØ±Ø¹ 2">
      </div>
      <div>
        <div class="label">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
        <textarea class="input" id="acc_note" placeholder="Ù…Ø«Ø§Ù„: Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© / Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ / ØªÙØ§ØµÙŠÙ„..."></textarea>
      </div>
      <div>
        <div class="label">Ø§Ù„Ù†ÙˆØ¹</div>
        <select id="acc_kind">
          <option value="CASH">ØµÙ†Ø¯ÙˆÙ‚</option>
          <option value="WALLET">Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
          <option value="ACCOUNT">Ø­Ø³Ø§Ø¨</option>
        </select>
      </div>
      <button class="btn primary wide" onclick="addAccount()">Ø­ÙØ¸</button>
    </div>
  `);
}
function addAccount(){
  const name = normalizeDigits(document.getElementById("acc_name").value).trim();
  const kind = document.getElementById("acc_kind").value;
  if(!name) return toast("Ø®Ø·Ø£", "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨");
  DB.accounts.push({ id: uid("a"), name, kind, active:true, createdAt: new Date().toISOString() });
  saveDB();
  closeModal();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸", "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨");
  renderAccounts();
  fillAccountFilter();
  renderBalances();
}
function openEditAccount(id){
  const a = DB.accounts.find(x => x.id === id);
  if(!a) return;
  openModal("ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨", `
    <div class="grid">
      <div>
        <div class="label">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</div>
        <input class="input" id="acc_name" value="${escapeAttr(a.name)}">
      </div>
      <div>
        <div class="label">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
        <textarea class="input" id="acc_note" placeholder="Ù…Ø«Ø§Ù„: Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© / Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ / ØªÙØ§ØµÙŠÙ„...">${escapeHtml(a.note||"")}</textarea>
      </div>
      <div>
        <div class="label">Ø§Ù„Ù†ÙˆØ¹</div>
        <select id="acc_kind">
          <option value="CASH" ${a.kind==="CASH"?"selected":""}>ØµÙ†Ø¯ÙˆÙ‚</option>
          <option value="WALLET" ${a.kind==="WALLET"?"selected":""}>Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
          <option value="ACCOUNT" ${a.kind==="ACCOUNT"?"selected":""}>Ø­Ø³Ø§Ø¨</option>
        </select>
      </div>
      <button class="btn primary wide" onclick="saveAccount('${id}')">Ø­ÙØ¸</button>
    </div>
  `);
}
function saveAccount(id){
  const a = DB.accounts.find(x => x.id === id);
  if(!a) return;
  const name = normalizeDigits(document.getElementById("acc_name").value).trim();
  const note = normalizeDigits(document.getElementById("acc_note").value).trim();
  const kind = document.getElementById("acc_kind").value;
  if(!name) return toast("Ø®Ø·Ø£", "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨");
  a.name = name;
  a.kind = kind;
  a.note = note;
  saveDB();
  closeModal();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸", "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨");
  renderAccounts();
  fillAccountFilter();
  renderBalances();
}
function toggleAccount(id){
  const a = DB.accounts.find(x => x.id === id);
  if(!a) return;
  a.active = !a.active;
  saveDB();
  toast("ØªÙ…", a.active ? "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨" : "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ø³Ø§Ø¨");
  renderAccounts();
  fillAccountFilter();
  renderBalances();
}
function deleteAccount(id){
  const a = DB.accounts.find(x => x.id === id);
  if(!a) return;
  const used = DB.tx.some(t => t.accountId === id);
  if(used) return toast("ØºÙŠØ± Ù…Ù…ÙƒÙ†", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø¨Ù‡ Ø¹Ù…Ù„ÙŠØ§Øª");
  openModal("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø­Ø³Ø§Ø¨", `
    <div class="hintbox">
      Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ <b>${escapeHtml(a.name)}</b>ØŸ
    </div>
    <div class="sep"></div>
    <div class="row">
      <button class="btn danger" onclick="confirmDeleteAccount('${id}')">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
      <button class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `);
}
function confirmDeleteAccount(id){
  DB.accounts = DB.accounts.filter(a => a.id !== id);
  saveDB();
  closeModal();
  toast("ØªÙ… Ø§Ù„Ø­Ø°Ù", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨");
  renderAccounts();
  fillAccountFilter();
  renderBalances();
}

/* ======= USERS MODALS ======= */
function openAddUser(){
  if(!isAdmin()) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­", "Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·");
  openModal("Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…", `
    <div class="grid">
      <div>
        <div class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
        <input class="input" id="u_name" placeholder="Ù…Ø«Ø§Ù„: ahmed">
      </div>
      <div>
        <div class="label">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</div>
        <input class="input" id="u_pass" type="password" placeholder="Ù…Ø«Ø§Ù„: 12345">
      </div>
      <div>
        <div class="label">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</div>
        <select id="u_role">
          <option value="USER">USER</option>
          <option value="ADMIN">ADMIN</option>
        </select>
      </div>
      <button class="btn primary wide" onclick="addUser()">Ø­ÙØ¸</button>
    </div>
  `);
}
function addUser(){
  const username = normalizeDigits(document.getElementById("u_name").value).trim().toLowerCase();
  const pass = normalizeDigits(document.getElementById("u_pass").value).trim();
  const role = document.getElementById("u_role").value;
  if(!username) return toast("Ø®Ø·Ø£", "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
  if(!pass) return toast("Ø®Ø·Ø£", "Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±");
  if(DB.users.some(u=>u.username.toLowerCase()===username)) return toast("Ø®Ø·Ø£", "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„");
  DB.users.push({ id: uid("u"), username, pass, role, active:true, createdAt: new Date().toISOString() });
  saveDB();
  closeModal();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸", "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
  renderUsers();
}
function openEditUser(id){
  if(!isAdmin()) return;
  const u = DB.users.find(x => x.id === id);
  if(!u) return;
  openModal("ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…", `
    <div class="grid">
      <div>
        <div class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
        <input class="input" id="u_name" value="${escapeAttr(u.username)}">
      </div>
      <div>
        <div class="label">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</div>
        <input class="input" id="u_pass" type="text" value="${escapeAttr(u.pass)}">
        <div class="sub" style="margin-top:6px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ ØªØ·Ø¨ÙŠÙ‚ Ù…Ø­Ù„ÙŠ â€” ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØªÙØ­ÙØ¸ ÙƒÙ…Ø§ Ù‡ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø².</div>
      </div>
      <div>
        <div class="label">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</div>
        <select id="u_role">
          <option value="USER" ${u.role==="USER"?"selected":""}>USER</option>
          <option value="ADMIN" ${u.role==="ADMIN"?"selected":""}>ADMIN</option>
        </select>
      </div>
      <button class="btn primary wide" onclick="saveUser('${id}')">Ø­ÙØ¸</button>
    </div>
  `);
}
function saveUser(id){
  const u = DB.users.find(x => x.id === id);
  if(!u) return;
  const username = normalizeDigits(document.getElementById("u_name").value).trim().toLowerCase();
  const pass = normalizeDigits(document.getElementById("u_pass").value).trim();
  const role = document.getElementById("u_role").value;
  if(!username) return toast("Ø®Ø·Ø£", "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
  if(!pass) return toast("Ø®Ø·Ø£", "Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±");
  if(DB.users.some(x=>x.id!==id && x.username.toLowerCase()===username)) return toast("Ø®Ø·Ø£", "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„");
  u.username = username;
  u.pass = pass;
  u.role = role;
  saveDB();
  closeModal();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸", "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
  renderUsers();
}
function toggleUser(id){
  if(!isAdmin()) return;
  const me = currentUser();
  if(me && me.id === id) return toast("ØºÙŠØ± Ù…Ù…ÙƒÙ†", "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙŠÙ‚Ø§Ù Ù†ÙØ³Ùƒ");
  const u = DB.users.find(x => x.id === id);
  if(!u) return;
  u.active = !u.active;
  saveDB();
  toast("ØªÙ…", u.active ? "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" : "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
  renderUsers();
}

/* ======= IMPORT EXCEL ======= */
let XLSX_WORKBOOK = null;

function prepareImportView(){
  const file = document.getElementById("xlsxFile");
  const sheetSel = document.getElementById("xlsxSheet");
  const btn = document.getElementById("importBtn");
  sheetSel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù â€”</option>`;
  btn.disabled = true;
  document.getElementById("importInfo").textContent = "Ø¬Ø§Ù‡Ø²";
  file.value = "";
  XLSX_WORKBOOK = null;
}

document.getElementById("xlsxFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  const sheetSel = document.getElementById("xlsxSheet");
  const btn = document.getElementById("importBtn");
  if(!f){ sheetSel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù â€”</option>`; btn.disabled = true; return; }

  try{
    const data = await f.arrayBuffer();
    XLSX_WORKBOOK = XLSX.read(data, {type:"array"});
    const names = XLSX_WORKBOOK.SheetNames || [];
    sheetSel.innerHTML = names.map(n => `<option value="${escapeAttr(n)}">${escapeHtml(n)}</option>`).join("");
    btn.disabled = names.length === 0;
    document.getElementById("importInfo").textContent = "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù";
  }catch(err){
    console.error(err);
    toast("ÙØ´Ù„", "ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel");
    XLSX_WORKBOOK = null;
    btn.disabled = true;
  }
});

document.getElementById("importBtn").addEventListener("click", ()=>{
  const sheetName = document.getElementById("xlsxSheet").value;
  if(!XLSX_WORKBOOK || !sheetName) return toast("Ø®Ø·Ø£", "Ø§Ø®ØªØ± ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„");
  const ws = XLSX_WORKBOOK.Sheets[sheetName];
  if(!ws) return toast("Ø®Ø·Ø£", "ÙˆØ±Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");

  const rows = XLSX.utils.sheet_to_json(ws, {defval:""});
  if(rows.length === 0) return toast("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ø©");

  const mapKey = (k)=> normalizeDigits(String(k)).trim().toLowerCase();
  const get = (obj, keys)=>{
    for(const k of keys){
      const v = obj[k];
      if(v !== undefined && v !== null && String(v).trim() !== "") return v;
    }
    return "";
  };

  let addedTx = 0, addedAcc = 0, skipped = 0;

  for(const r of rows){
    // Build normalized object by lowering keys
    const nr = {};
    for(const [k,v] of Object.entries(r)){
      nr[mapKey(k)] = v;
    }

    let date = get(nr, ["date","Ø§Ù„ØªØ§Ø±ÙŠØ®"]);
    let accountName = String(get(nr, ["account","Ø§Ù„Ø­Ø³Ø§Ø¨","Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"])).trim();
    let type = String(get(nr, ["type","Ø§Ù„Ù†ÙˆØ¹"])).trim();
    let amountVal = get(nr, ["amount","Ø§Ù„Ù…Ø¨Ù„Øº"]);
    let note = String(get(nr, ["note","Ø§Ù„ÙˆØµÙ","Ù…Ù„Ø§Ø­Ø¸Ø©"])).trim();
    let ref = String(get(nr, ["ref","Ø§Ù„Ù…Ø±Ø¬Ø¹","Ø±Ù‚Ù…"])).trim();

    // date can be Excel date number
    date = excelDateToISO(date);
    if(!date || !accountName || !amountVal){
      skipped++;
      continue;
    }

    type = normalizeType(type);
    const amount = parseAmount(amountVal);
    if(!Number.isFinite(amount) || amount<=0){ skipped++; continue; }

    // find or create account by name
    let acc = DB.accounts.find(a => a.name.trim() === accountName);
    if(!acc){
      acc = { id: uid("a"), name: accountName, kind:"ACCOUNT", active:true, createdAt: new Date().toISOString() };
      DB.accounts.push(acc);
      addedAcc++;
    }

    DB.tx.push({
      id: uid("tx"),
      date,
      accountId: acc.id,
      type,
      amount,
      note: normalizeDigits(note),
      ref: normalizeDigits(ref),
      createdAt: new Date().toISOString()
    });
    addedTx++;
  }

  saveDB();
  toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯", `Ø¹Ù…Ù„ÙŠØ§Øª: ${addedTx} â€¢ Ø­Ø³Ø§Ø¨Ø§Øª: ${addedAcc} â€¢ ØªÙ… ØªØ®Ø·ÙŠ: ${skipped}`);
  renderBalances();
  fillAccountFilter();
  renderTransactions();
});

function normalizeType(t){
  const s = normalizeDigits(String(t)).trim().toLowerCase();
  if(["in","Ù‚Ø¨Ø¶","Ø§ÙŠØ±Ø§Ø¯","Ø¥ÙŠØ±Ø§Ø¯","Ø¯Ø®Ù„","+","receive","received"].includes(s)) return "IN";
  if(["out","ØµØ±Ù","Ù…ØµØ±ÙˆÙ","Ø®ØµÙ…","-","pay","paid"].includes(s)) return "OUT";
  // if empty default IN
  return (s.includes("out") || s.includes("ØµØ±Ù") || s.includes("Ù…Øµ")) ? "OUT" : "IN";
}

function excelDateToISO(v){
  if(v == null) return "";
  // already iso yyyy-mm-dd
  const s = normalizeDigits(String(v)).trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // if JS Date string
  const d1 = new Date(v);
  if(!Number.isNaN(d1.getTime())){
    const y = d1.getFullYear();
    const m = String(d1.getMonth()+1).padStart(2,"0");
    const d = String(d1.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }

  // Excel serial date number
  const n = Number(s);
  if(Number.isFinite(n) && n > 20000 && n < 60000){
    // Excel epoch 1899-12-30 (for Windows)
    const epoch = new Date(Date.UTC(1899,11,30));
    const ms = n * 24*60*60*1000;
    const dt = new Date(epoch.getTime() + ms);
    const y = dt.getUTCFullYear();
    const m = String(dt.getUTCMonth()+1).padStart(2,"0");
    const d = String(dt.getUTCDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }

  // dd/mm/yyyy or dd-mm-yyyy
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m){
    const dd = String(m[1]).padStart(2,"0");
    const mm = String(m[2]).padStart(2,"0");
    const yy = m[3];
    return `${yy}-${mm}-${dd}`;
  }
  return "";
}

function downloadTemplate(){
  // create small xlsx template in browser using XLSX
  const rows = [
    {date: nowISO(), account: "Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚", type:"IN", amount: 1000, note:"Ø¥ÙŠØ±Ø§Ø¯", ref:""},
    {date: nowISO(), account: "ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´", type:"OUT", amount: 250, note:"Ù…ØµØ±ÙˆÙ", ref:""}
  ];
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Transactions");
  const wbout = XLSX.write(wb, {bookType:"xlsx", type:"array"});
  const blob = new Blob([wbout], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "VIP_Cashbook_Template.xlsx";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

/* ======= SETTINGS: BACKUP/RESTORE/WIPE ======= */
function backupDownload(){
  const blob = new Blob([JSON.stringify(DB, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "vip-cashbook-backup.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

document.getElementById("restoreFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    if(!obj || !obj.users || !obj.accounts || !obj.tx) throw new Error("Invalid backup");
    DB = obj;
    if(!DB.session) DB.session = {userId:null};
    saveDB();
    toast("ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©", "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©");
    boot();
  }catch(err){
    console.error(err);
    toast("ÙØ´Ù„", "Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
  }finally{
    e.target.value = "";
  }
});

function confirmWipe(){
  openModal("Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", `
    <div class="hintbox danger-text">
      ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†/Ø­Ø³Ø§Ø¨Ø§Øª/Ø¹Ù…Ù„ÙŠØ§Øª) Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².
    </div>
    <div class="sep"></div>
    <div class="row">
      <button class="btn danger" onclick="wipeAll()">Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­</button>
      <button class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `);
}
function wipeAll(){
  localStorage.removeItem(APP_KEY);
  DB = defaultDB();
  saveDB();
  closeModal();
  toast("ØªÙ…", "ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·");
  boot();
}

/* ======= EXPORT JSON (quick) ======= */
function exportJson(){
  backupDownload();
}

/* ======= SECURITY HELPERS (basic) ======= */
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function escapeAttr(str){
  return escapeHtml(str).replaceAll("\n"," ");
}


/* ======= PRINT (Arabic-friendly PDF via browser print) ======= */
function openPrintWindow(title, htmlBody){
  const w = window.open("", "_blank");
  if(!w){ toast("ØªÙ†Ø¨ÙŠÙ‡","Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©"); return; }
  const css = `
    <style>
      @page{ size:A4; margin:14mm; }
      body{
      overflow-x:hidden; font-family: Arial, "Cairo", system-ui; direction:rtl; color:#111; }
      h1{ margin:0 0 10px 0; font-size:18px; }
      .meta{ font-size:12px; color:#444; margin-bottom:10px; }
      .cards{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
      .card{ border:1px solid #ddd; border-radius:10px; padding:10px; }
      .card .t{ font-size:12px; color:#555; margin-bottom:6px; }
      .card .v{ font-size:18px; font-weight:800; }
      table{ width:100%; border-collapse:collapse; font-size:12px; }
      th,td{ border:1px solid #ddd; padding:8px; text-align:right; vertical-align:top; }
      th{ background:#f3f4f6; }
      .tag{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; font-weight:700; font-size:11px; }
      .in{ background:#ecfdf5; border-color:#a7f3d0; }
      .out{ background:#fef2f2; border-color:#fecaca; }
      .foot{ margin-top:12px; font-size:11px; color:#666; }
      @media print{ .no-print{ display:none } }
    </style>
  `;
  w.document.open();
  w.document.write(`<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>${title}</title>${css}</head><body>${htmlBody}</body></html>`);
  w.document.close();
  setTimeout(()=>{ w.focus(); w.print(); }, 450);
}

function printBalances(){
  const bal = computeBalances();
  const ac = activeAccounts().slice().sort((a,b)=>(bal[b.id]||0)-(bal[a.id]||0));
  const total = ac.reduce((s,a)=>s+(bal[a.id]||0),0);
  const meta = `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString("ar-EG")}`;
  const rows = ac.map(a=>{
    const kind = a.kind==="CASH"?"ØµÙ†Ø¯ÙˆÙ‚":a.kind==="WALLET"?"Ù…Ø­ÙØ¸Ø©":"Ø­Ø³Ø§Ø¨";
    return `<tr><td>${escapeHtml(a.name)}</td><td>${kind}</td><td style="direction:ltr;text-align:left">${money(bal[a.id]||0)} EGP</td></tr>`;
  }).join("");
  const body = `
    <h1>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø±ØµØ¯Ø©</h1>
    <div class="meta">${meta}</div>
    <div class="cards">
      <div class="card"><div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div><div class="v" style="direction:ltr;text-align:left">${money(total)} EGP</div></div>
      <div class="card"><div class="t">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div><div class="v">${ac.length}</div></div>
    </div>
    <table>
      <thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <div class="foot">VIP Cashbook</div>
  `;
  openPrintWindow("Balances", body);
}

function printTransactions(){
  const a = document.getElementById("fAccount").value;
  const q = normalizeDigits(document.getElementById("fSearch").value).toLowerCase();
  const from = document.getElementById("fFrom").value;
  const to = document.getElementById("fTo").value;

  let rows = DB.tx.slice().filter(t=>{
    if(a && t.accountId !== a) return false;
    const d = String(t.date||"");
    if(from && d < from) return false;
    if(to && d > to) return false;
    if(q){
      const blob = [t.id,t.date,t.type,t.amount,accountById(t.accountId)?.name||"",t.note||"",t.ref||""].join(" ").toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });
  rows.sort((x,y)=> (y.date||"").localeCompare(x.date||"") || (y.createdAt||"").localeCompare(x.createdAt||""));

  let totalIn=0,totalOut=0;
  for(const t of rows){
    const amt = Number(t.amount||0);
    if(String(t.type).toUpperCase()==="IN") totalIn += amt; else totalOut += amt;
  }
  const totalNet = totalIn-totalOut;

  const metaParts = [];
  metaParts.push(`ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString("ar-EG")}`);
  if(a) metaParts.push(`Ø§Ù„Ø­Ø³Ø§Ø¨: ${escapeHtml(accountById(a)?.name||"")}`);
  if(from) metaParts.push(`Ù…Ù†: ${escapeHtml(from)}`);
  if(to) metaParts.push(`Ø¥Ù„Ù‰: ${escapeHtml(to)}`);
  if(q) metaParts.push(`Ø¨Ø­Ø«: ${escapeHtml(q)}`);

  const meta = metaParts.join(" â€¢ ");

  const bodyRows = rows.map(t=>{
    const acc = accountById(t.accountId)?.name||"";
    const typ = String(t.type).toUpperCase()==="IN" ? `<span class="tag in">Ù‚Ø¨Ø¶</span>` : `<span class="tag out">ØµØ±Ù</span>`;
    return `<tr>
      <td>${escapeHtml(t.date||"")}</td>
      <td>${escapeHtml(acc)}</td>
      <td>${typ}</td>
      <td style="direction:ltr;text-align:left">${money(t.amount)} EGP</td>
      <td>${escapeHtml(t.ref||"")}</td>
      <td>${escapeHtml(t.note||"")}</td>
    </tr>`;
  }).join("");

  const body = `
    <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h1>
    <div class="meta">${meta}</div>
    <div class="cards">
      <div class="card"><div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª</div><div class="v" style="direction:ltr;text-align:left">${money(totalIn)} EGP</div></div>
      <div class="card"><div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div><div class="v" style="direction:ltr;text-align:left">${money(totalOut)} EGP</div></div>
      <div class="card"><div class="t">Ø§Ù„Ø±ØµÙŠØ¯ (ØµØ§ÙÙŠ)</div><div class="v" style="direction:ltr;text-align:left">${money(totalNet)} EGP</div></div>
      <div class="card"><div class="t">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div><div class="v">${rows.length}</div></div>
    </div>
    <table>
      <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ø±Ø¬Ø¹</th><th>ÙˆØµÙ</th></tr></thead>
      <tbody>${bodyRows}</tbody>
    </table>
    <div class="foot">VIP Cashbook</div>
  `;
  openPrintWindow("Transactions", body);
}


/* ======= BOOT ======= */
document.getElementById("loginBtn").addEventListener("click", ()=>{
  const u = document.getElementById("loginUser").value;
  const p = document.getElementById("loginPass").value;
  const res = login(u,p);
  if(!res.ok){
    toast("ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„", res.error);
    return;
  }
  toast("Ù…Ø±Ø­Ø¨Ø§Ù‹", "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
  boot();
});
document.getElementById("loginPass").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") document.getElementById("loginBtn").click();
});

function boot(){
  DB = loadDB();
  const u = currentUser();

  const nav = document.getElementById("nav");
  const topbar = document.getElementById("topbar");
  const userPill = document.getElementById("userPill");
  const logoutBtn = document.getElementById("logoutBtn");
  const usersTab = document.getElementById("usersTab");

  if(!u){
    nav.style.display = "none";
    userPill.style.display = "none";
    logoutBtn.style.display = "none";
    usersTab.style.display = "none";
    document.getElementById("subtitle").textContent = "Mobile App (PWA)";
    switchView("login");
    return;
  }

  // logged in
  nav.style.display = "flex";
  userPill.style.display = "flex";
  logoutBtn.style.display = "inline-flex";
  usersTab.style.display = isAdmin() ? "inline-flex" : "none";
  const st = document.getElementById('settingsTab'); if(st) st.style.display = isAdmin() ? 'inline-flex' : 'none';

  document.getElementById("userName").textContent = u.username;
  document.getElementById("userRole").textContent = u.role;

  document.getElementById("subtitle").textContent = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„ â€¢ " + new Date().toLocaleDateString("ar-EG");

  // default view
  switchView("balances");
}

// initial
boot();

/* ======= ADMIN GUARDS ======= */
function guardAdmin(view){
  if(view === "settings" && !isAdmin()){
    toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­", "ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·");
    return false;
  }
  return true;
}




/* ======= FULLSCREEN ======= */
function tryFullscreen(){
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if(isStandalone){
    const el = document.documentElement;
    if(el.requestFullscreen) el.requestFullscreen().catch(()=>{});
  }
}
window.addEventListener('load', ()=> setTimeout(tryFullscreen, 800));

</script>
</body>
</html>
