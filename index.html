<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111827"/>
  <title>VIP Cashbook</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="mobile-web-app-capable" content="yes"/>
<style>
/* VIP Cashbook - Modern RTL UI */
:root{
  --bg: #0b1220;
  --card: rgba(17, 24, 39, .72);
  --card2: rgba(17, 24, 39, .52);
  --text: #e5e7eb;
  --muted: rgba(229,231,235,.72);
  --line: rgba(148,163,184,.18);
  --primary: #7c3aed;
  --primary2: #22c55e;
  --danger: #ef4444;
  --shadow: 0 16px 40px rgba(0,0,0,.35);
  --radius: 18px;
  --radius2: 24px;
}

:root[data-theme="light"]{
  --bg: #f5f7fb;
  --card: rgba(255,255,255,.85);
  --card2: rgba(255,255,255,.72);
  --text: #0f172a;
  --muted: rgba(15,23,42,.6);
  --line: rgba(15,23,42,.12);
  --shadow: 0 16px 40px rgba(15,23,42,.12);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: "Cairo", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

.bg{
  position:fixed; inset:0;
  background:
    radial-gradient(800px 500px at 10% 10%, rgba(124,58,237,.30), transparent 60%),
    radial-gradient(700px 480px at 85% 20%, rgba(34,197,94,.18), transparent 60%),
    radial-gradient(900px 600px at 50% 110%, rgba(59,130,246,.14), transparent 60%);
  pointer-events:none;
}

.hidden{display:none !important}

/* AUTH */
.auth{
  min-height:100vh;
  display:grid;
  place-items:center;
  padding:24px;
}
.auth-card{
  width:min(520px, 100%);
  background: var(--card);
  border:1px solid var(--line);
  border-radius: var(--radius2);
  box-shadow: var(--shadow);
  padding:22px;
  backdrop-filter: blur(10px);
}
.auth-brand{
  display:flex;
  align-items:center;
  gap:14px;
  margin-bottom:18px;
}
.vip-badge{
  width:52px;height:52px;
  display:grid;place-items:center;
  border-radius:16px;
  background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.75));
  font-weight:900;
  letter-spacing:1px;
  box-shadow: 0 10px 24px rgba(124,58,237,.25);
}
.vip-badge.small{width:42px;height:42px;border-radius:14px}
.auth-brand h1{margin:0;font-size:26px}
.auth-brand p{margin:2px 0 0;color:var(--muted)}
.auth-form{display:flex;flex-direction:column;gap:12px}
label span{display:block;font-size:13px;color:var(--muted);margin:0 0 6px}
input,select{
  width:100%;
  border:1px solid var(--line);
  background: rgba(0,0,0,.08);
  color: var(--text);
  border-radius: 14px;
  padding:12px 12px;
  outline:none;
}
:root[data-theme="light"] input,
:root[data-theme="light"] select{
  background: rgba(15,23,42,.04);
}
input:focus, select:focus{
  border-color: rgba(124,58,237,.55);
  box-shadow: 0 0 0 4px rgba(124,58,237,.15);
}
.pass-wrap{display:flex;gap:10px;align-items:center}
.icon-btn{
  border:1px solid var(--line);
  background: rgba(0,0,0,.08);
  color:var(--text);
  border-radius:14px;
  padding:10px 12px;
  cursor:pointer;
}
.btn{
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
  color: var(--text);
  border-radius: 14px;
  padding:12px 14px;
  cursor:pointer;
  font-weight:700;
}
.btn.primary{
  background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.70));
  border-color: transparent;
}
.btn:hover{filter:brightness(1.05)}
.muted{color:var(--muted)}
.small{font-size:12px}
.auth-hint{
  margin-top:10px;
  border:1px dashed var(--line);
  background: var(--card2);
  border-radius: 16px;
  padding:12px;
}
.hint-title{font-weight:800;margin-bottom:8px}
.hint-row{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px}
code{
  background: rgba(124,58,237,.18);
  border:1px solid rgba(124,58,237,.28);
  padding:2px 8px;
  border-radius: 10px;
  color: var(--text);
}

/* APP LAYOUT */
.app{
  min-height:100vh;
  display:grid;
  grid-template-columns: 280px 1fr;
  grid-template-rows: 70px 1fr;
  grid-template-areas:
    "topbar topbar"
    "sidebar content";
}
.topbar{
  grid-area: topbar;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid var(--line);
  background: rgba(0,0,0,.06);
  backdrop-filter: blur(10px);
  position:sticky; top:0; z-index:10;
}
.brand{display:flex;align-items:center;gap:12px}
.brand-text .title{font-weight:900;font-size:18px}
.brand-text .subtitle{color:var(--muted);font-size:12px;margin-top:2px}
.top-actions{display:flex;gap:8px;flex-wrap:wrap}
.chip{
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
  color: var(--text);
  border-radius: 999px;
  padding:10px 12px;
  cursor:pointer;
  font-weight:800;
}
.chip.danger{border-color: rgba(239,68,68,.35)}
.chip:hover{filter:brightness(1.06)}
.sidebar{
  grid-area: sidebar;
  border-left:1px solid var(--line);
  padding:14px;
}
.nav{display:flex;flex-direction:column;gap:10px}
.nav-item{
  display:flex;
  align-items:center;
  gap:10px;
  border:1px solid var(--line);
  background: var(--card2);
  color: var(--text);
  border-radius: 16px;
  padding:12px 14px;
  cursor:pointer;
  font-weight:900;
}
.nav-ico{width:28px;display:inline-grid;place-items:center}
.nav-item.active{
  border-color: rgba(124,58,237,.5);
  box-shadow: 0 0 0 4px rgba(124,58,237,.12);
}
.nav-footer{margin-top:auto;display:grid;gap:10px}
.pill{
  border:1px solid var(--line);
  background: var(--card2);
  border-radius: 16px;
  padding:12px 14px;
}
.pill-title{font-size:12px;color:var(--muted)}
.pill-value{font-weight:900;margin-top:4px}

.content{
  grid-area: content;
  padding:14px;
}
.view{display:block}
.card{
  background: var(--card);
  border:1px solid var(--line);
  border-radius: var(--radius2);
  box-shadow: var(--shadow);
  padding:14px;
  backdrop-filter: blur(10px);
}
.card + .card{margin-top:14px}
.card-head{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  margin-bottom:12px;
}
.card-head h2{margin:0;font-size:18px}
.grid-2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:14px;
  margin-bottom:14px;
}
.kpis{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:12px;
}
.kpi{
  border:1px solid var(--line);
  background: var(--card2);
  border-radius: 18px;
  padding:12px;
}
.kpi-label{color:var(--muted);font-size:12px}
.kpi-value{font-weight:1000;font-size:20px;margin-top:6px}
.form{display:flex;flex-direction:column;gap:12px}
.row{display:flex;gap:12px}
.grow{flex:1}
.divider{height:1px;background:var(--line);margin:14px 0}
.filters{
  display:grid;
  grid-template-columns: 1.3fr 1fr 1fr 1.2fr auto;
  gap:10px;
  align-items:end;
}
.table-wrap{overflow:auto}
.table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  min-width: 760px;
}
.table thead th{
  text-align:right;
  font-size:12px;
  color:var(--muted);
  padding:10px 10px;
  border-bottom:1px solid var(--line);
}
.table tbody td{
  padding:12px 10px;
  border-bottom:1px solid var(--line);
}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
  font-weight:900;
  font-size:12px;
}
.badge.in{border-color: rgba(34,197,94,.35)}
.badge.out{border-color: rgba(239,68,68,.35)}
.actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.btn.small{padding:8px 10px;border-radius:12px;font-weight:900}
.btn.danger{border-color: rgba(239,68,68,.35); color: var(--text)}
.btn.ghost{background: rgba(255,255,255,.02)}
.toast{
  position:fixed;
  left:14px; bottom:14px;
  border:1px solid var(--line);
  background: var(--card);
  border-radius: 16px;
  padding:12px 14px;
  box-shadow: var(--shadow);
  z-index:100;
}

/* MOBILE */
@media (max-width: 980px){
  .app{
    grid-template-columns: 1fr;
    grid-template-rows: 70px auto 1fr;
    grid-template-areas:
      "topbar"
      "sidebar"
      "content";
  }
  .sidebar{border-left:none;border-bottom:1px solid var(--line)}
  .nav{flex-direction:row;flex-wrap:wrap}
  .nav-item{flex:1;min-width:160px}
  .nav-footer{width:100%;grid-template-columns:1fr 1fr}
  .grid-2{grid-template-columns:1fr}
  .kpis{grid-template-columns:1fr}
  .filters{grid-template-columns:1fr 1fr}
  .table{min-width: 720px}
}




/* MOBILE VIP: top navigation (not bottom) */
@media (max-width: 980px){
  .app{
    grid-template-columns: 1fr;
    grid-template-rows: 70px auto 1fr;
    grid-template-areas:
      "topbar"
      "sidebar"
      "content";
  }
  .sidebar{
    position: sticky;
    top: 70px;
    z-index: 9;
    border-left: none;
    border-bottom: 1px solid var(--line);
    padding: 10px;
    background: rgba(0,0,0,.06);
    backdrop-filter: blur(12px);
  }
  :root[data-theme="light"] .sidebar{
    background: rgba(255,255,255,.65);
  }
  .nav{
    flex-direction: row;
    flex-wrap: nowrap;
    overflow-x: auto;
    gap: 10px;
    -webkit-overflow-scrolling: touch;
  }
  .nav-item{
    min-width: 150px;
    justify-content: center;
    padding: 12px 12px;
    border-radius: 18px;
    white-space: nowrap;
  }
  .nav-footer{display:none;}
  .content{padding: 12px;}
  .grid-2{grid-template-columns:1fr;}
  .kpis{grid-template-columns:1fr;}
  .filters{grid-template-columns:1fr 1fr;}
  .table{min-width: 860px;}
}


/* ===== ULTRA MOBILE OPTIMIZATION ===== */
@media (max-width: 600px){

  body{
    font-size:15px;
  }

  .topbar{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
    padding:10px;
  }

  .top-actions{
    width:100%;
    justify-content:space-between;
  }

  .chip{
    flex:1;
    text-align:center;
    font-size:13px;
    padding:10px 6px;
  }

  .sidebar{
    top:60px;
  }

  .nav-item{
    min-width:120px;
    font-size:13px;
    padding:10px 8px;
  }

  .card{
    padding:12px;
    border-radius:16px;
  }

  .card-head h2{
    font-size:16px;
  }

  input, select{
    font-size:15px;
  }

  .btn{
    width:100%;
    text-align:center;
  }

  .filters{
    grid-template-columns:1fr;
  }

  .row{
    flex-direction:column;
  }

  .kpi-value{
    font-size:18px;
  }

  .table{
    font-size:13px;
  }

}


/* MOBILE VIP: keep tables, use horizontal scroll */
@media (max-width: 520px){
  .topbar{padding:10px 10px;}
  .brand-text .title{font-size:16px}
  .brand-text .subtitle{display:none;}
  .top-actions{gap:6px}
  .chip{padding:9px 10px}
  .nav-item{min-width: 130px;}
}


/* ===== PREMIUM TABLE (VIP) ===== */
.table-wrap{
  position: relative;
  border-radius: 18px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.02);
}
.table-wrap::before,
.table-wrap::after{
  content:"";
  position:absolute;
  top:0; bottom:0;
  width:18px;
  pointer-events:none;
}
.table-wrap::before{
  right:0;
  background: linear-gradient(270deg, rgba(0,0,0,.18), transparent);
}
:root[data-theme="light"] .table-wrap::before{
  background: linear-gradient(270deg, rgba(15,23,42,.10), transparent);
}
.table-wrap::after{
  left:0;
  background: linear-gradient(90deg, rgba(0,0,0,.18), transparent);
}
:root[data-theme="light"] .table-wrap::after{
  background: linear-gradient(90deg, rgba(15,23,42,.10), transparent);
}

.table{
  width:100%;
  border-collapse: separate;
  border-spacing: 0;
  min-width: 920px;
}
.table thead th{
  position: sticky;
  top: 0;
  z-index: 2;
  background: rgba(0,0,0,.18);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--line);
  font-weight: 900;
  letter-spacing: .2px;
}
:root[data-theme="light"] .table thead th{
  background: rgba(255,255,255,.75);
}
.table tbody tr{
  transition: transform .12s ease, filter .12s ease, background .12s ease;
}
.table tbody tr:nth-child(odd){
  background: rgba(255,255,255,.02);
}
.table tbody tr:hover{
  background: rgba(124,58,237,.08);
}
.table tbody td{
  vertical-align: middle;
}
.badge{
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 1000;
}
.badge.in{
  background: rgba(34,197,94,.10);
  border-color: rgba(34,197,94,.28);
}
.badge.out{
  background: rgba(239,68,68,.10);
  border-color: rgba(239,68,68,.28);
}

/* Actions: nicer buttons in table */
.actions .btn.small{
  padding: 9px 12px;
  border-radius: 14px;
}
.actions .btn.small.ghost{
  background: rgba(255,255,255,.03);
}
.actions .btn.small.ghost:hover{
  filter: brightness(1.08);
}

/* MOBILE: keep table with scroll, reduce min-width a bit */
@media (max-width: 720px){
  .table{ min-width: 860px; }
  .table-wrap{ overflow:auto; }
  .table-wrap::before, .table-wrap::after{ display:none; }
}
@media (max-width: 520px){
  .table{ min-width: 820px; }
}


/* ===== MOBILE BIG UI UPGRADE ===== */
@media (max-width: 720px){
  body{font-size:16px;}
  .card{padding:16px;}
  .kpi-value{font-size:22px;}
  .nav-item{font-size:15px;padding:14px 14px;}
  .chip{font-size:14px;padding:12px 14px;}
  input, select{font-size:16px;padding:14px;border-radius:16px;}
  .btn{font-size:16px;padding:14px 16px;border-radius:16px;}
  .table thead th{font-size:14px;padding:12px;}
  .table tbody td{font-size:15px;padding:14px 12px;}
  .actions .btn.small{font-size:14px;padding:10px 12px;}
}

@media (max-width: 520px){
  body{font-size:17px;}
  .topbar{padding:12px;}
  .brand-text .title{font-size:17px;}
  .nav-item{min-width:160px;}
  .kpi-value{font-size:24px;}
  .table{min-width:880px;}
}


/* ===== TX VIEW MODE (TABLE / CARDS) ===== */
body.tx-cards #txTable thead{display:none;}
body.tx-cards #txTable,
body.tx-cards #txTable tbody,
body.tx-cards #txTable tr,
body.tx-cards #txTable td{
  display:block;
  width:100%;
}
body.tx-cards #txTable{
  min-width: 0 !important;
}
body.tx-cards #txTable tr{
  border: 1px solid var(--line);
  background: var(--card2);
  border-radius: 20px;
  margin: 12px 0;
  overflow:hidden;
}
body.tx-cards #txTable td{
  border-bottom: 1px solid var(--line);
  padding: 14px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
body.tx-cards #txTable td:last-child{border-bottom:none;}
body.tx-cards #txTable td::before{
  content: attr(data-label);
  color: var(--muted);
  font-weight: 900;
  font-size: 13px;
  flex: 0 0 auto;
  max-width: 45%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
body.tx-cards #txTable td strong{font-size:16px;}
body.tx-cards .actions{justify-content:flex-start; gap:10px;}
body.tx-cards .actions .btn.small{padding: 12px 14px; font-size: 15px; border-radius: 16px;}

/* On mobile, default to cards for better 100% readability */
@media (max-width: 720px){
  body:not(.tx-table){ /* if user didn't force table */
    /* just a hint; JS will add tx-cards by default */
  }
  .table-wrap{border:none;background:transparent;}
  .table-wrap::before, .table-wrap::after{display:none;}
}


/* ===== ULTRA MOBILE SIZE BOOST ===== */
@media (max-width: 720px){
  html{font-size:18px;}
  body{font-size:18px;}
  .topbar{padding:14px;}
  .brand-text .title{font-size:18px;}
  .chip{font-size:16px;padding:14px 16px;border-radius:18px;}
  .nav-item{font-size:16px;padding:16px;border-radius:18px;}
  .card{padding:18px;border-radius:22px;}
  .card-head h2{font-size:18px;}
  label span{font-size:14px;}
  input, select{font-size:17px;padding:16px;border-radius:18px;}
  .btn{font-size:17px;padding:16px 18px;border-radius:18px;}
  .kpi-label{font-size:14px;}
  .kpi-value{font-size:26px;}
  .filters label span{font-size:14px;}
  .table tbody td{font-size:16px;}
}

@media (max-width: 480px){
  html{font-size:19px;}
  body{font-size:19px;}
  .chip{font-size:17px;}
  .btn{font-size:18px;}
  .nav-item{font-size:17px;}
  .kpi-value{font-size:28px;}
}


/* ===== PWA / APP-LIKE MOBILE ===== */
body{
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.topbar{
  padding-top: calc(12px + env(safe-area-inset-top));
}
.content{
  padding-bottom: calc(14px + env(safe-area-inset-bottom));
}
@media (max-width: 720px){
  .topbar{
    position: sticky;
    top: 0;
  }
  .sidebar{
    position: sticky;
    top: calc(70px + env(safe-area-inset-top));
  }
}


/* ===== MOBILE TOP NAV BAR (APP STYLE) ===== */
@media (max-width: 720px){
  .app{
    grid-template-rows: 64px auto 1fr;
    grid-template-areas:
      "topbar"
      "sidebar"
      "content";
  }

  .topbar{
    height:64px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    border-bottom:1px solid var(--line);
  }

  .sidebar{
    position:sticky;
    top:64px;
    background:rgba(0,0,0,.08);
    backdrop-filter:blur(12px);
    border-bottom:1px solid var(--line);
    padding:10px;
    z-index:5;
  }

  .nav{
    flex-direction:row;
    gap:10px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }

  .nav-item{
    flex:0 0 auto;
    min-width:130px;
    justify-content:center;
    padding:12px 14px;
    border-radius:16px;
    font-size:15px;
  }

  .nav-footer{display:none;}

  .content{
    padding-top:10px;
  }
}


/* ===== MOBILE MAX (100% APP) ===== */
@media (max-width: 720px){
  html{font-size:20px;}
  body{font-size:20px; line-height:1.45;}
  .vip-badge{transform: scale(1.05);}
  .vip-badge.small{transform: scale(1.12);}
  .brand-text .title{font-size:20px;}
  .top-actions{gap:8px;}
  .chip{font-size:17px; padding:16px 18px; border-radius:20px;}
  .chip.danger{padding:16px 18px;}
  .nav-item{font-size:17px; padding:14px 16px; border-radius:18px; min-width:150px;}
  .nav-ico{font-size:20px;}
  .card{padding:20px; border-radius:24px;}
  .card-head h2{font-size:20px;}
  .muted.small{font-size:14px;}
  label span{font-size:15px;}
  input, select{font-size:18px; padding:18px 16px; border-radius:18px;}
  .btn{font-size:18px; padding:18px 18px; border-radius:18px;}
  .btn.small{font-size:16px; padding:14px 14px;}
  .actions{gap:10px;}
  .kpis{grid-template-columns:1fr;}
  .kpi-label{font-size:15px;}
  .kpi-value{font-size:30px;}
  .filters{grid-template-columns:1fr;}
  .pass-wrap .icon-btn{font-size:20px; padding:12px 14px; border-radius:16px;}
}

/* Ultra small phones */
@media (max-width: 420px){
  html{font-size:21px;}
  body{font-size:21px;}
  .chip{font-size:18px;}
  .nav-item{font-size:18px; min-width:160px;}
  .nav-ico{font-size:22px;}
  .kpi-value{font-size:32px;}
}

/* ===== MOBILE: convert other tables (balances/accounts/users) to cards ===== */
@media (max-width: 720px){
  /* balances */
  #balancesTable{min-width:0 !important;}
  #balancesTable thead{display:none;}
  #balancesTable, #balancesTable tbody, #balancesTable tr, #balancesTable td{display:block;width:100%;}
  #balancesTable tr{border:1px solid var(--line); background: var(--card2); border-radius:22px; margin:12px 0; overflow:hidden;}
  #balancesTable td{border-bottom:1px solid var(--line); padding:16px 16px; display:flex; justify-content:space-between; align-items:center; gap:12px;}
  #balancesTable td:last-child{border-bottom:none;}
  #balancesTable td::before{content:attr(data-label); color:var(--muted); font-weight:900; font-size:14px; max-width:48%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

  /* accounts */
  #accTable{min-width:0 !important;}
  #accTable thead{display:none;}
  #accTable, #accTable tbody, #accTable tr, #accTable td{display:block;width:100%;}
  #accTable tr{border:1px solid var(--line); background: var(--card2); border-radius:22px; margin:12px 0; overflow:hidden;}
  #accTable td{border-bottom:1px solid var(--line); padding:16px 16px; display:flex; justify-content:space-between; align-items:center; gap:12px;}
  #accTable td:last-child{border-bottom:none;}
  #accTable td::before{content:attr(data-label); color:var(--muted); font-weight:900; font-size:14px; max-width:48%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

  /* users */
  #usersTable{min-width:0 !important;}
  #usersTable thead{display:none;}
  #usersTable, #usersTable tbody, #usersTable tr, #usersTable td{display:block;width:100%;}
  #usersTable tr{border:1px solid var(--line); background: var(--card2); border-radius:22px; margin:12px 0; overflow:hidden;}
  #usersTable td{border-bottom:1px solid var(--line); padding:16px 16px; display:flex; justify-content:space-between; align-items:center; gap:12px;}
  #usersTable td:last-child{border-bottom:none;}
  #usersTable td::before{content:attr(data-label); color:var(--muted); font-weight:900; font-size:14px; max-width:48%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
}


/* ===== WHATSAPP-LIKE ULTRA SCALE ===== */
@media (max-width: 720px){
  html{font-size:22px;}
  body{font-size:22px; line-height:1.5;}
  .brand-text .title{font-size:22px;}
  .chip{font-size:19px; padding:18px 20px;}
  .nav-item{font-size:19px; padding:16px 18px; min-width:170px;}
  .nav-ico{font-size:24px;}
  label span{font-size:17px;}
  input, select{font-size:20px; padding:20px;}
  .btn{font-size:20px; padding:20px;}
  .btn.small{font-size:18px; padding:16px;}
  .kpi-label{font-size:17px;}
  .kpi-value{font-size:34px;}
  .muted.small{font-size:15px;}
}

@media (max-width: 420px){
  html{font-size:23px;}
  body{font-size:23px;}
  .chip{font-size:20px;}
  .nav-item{font-size:20px;}
  .kpi-value{font-size:36px;}
}


/* ===== TOPBAR BRAND IN CORNER ===== */
@media (max-width: 720px){
  .topbar{
    justify-content: flex-start;
  }
  .brand{
    margin-left:auto;
  }
  .brand-text .subtitle{
    display:none;
  }
}

</style>
</head>
<body>
  <div class="bg"></div>

  <!-- LOGIN -->
  <main id="loginView" class="auth">
    <section class="auth-card">
      <div class="auth-brand">
        <div class="vip-badge">VIP</div>
        <div>
          <h1>Cashbook</h1>
          <p>Ø¯ÙØªØ± ÙŠÙˆÙ…ÙŠØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</p>
        </div>
      </div>

      <form id="loginForm" class="auth-form" autocomplete="on">
        <label>
          <span>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
          <input id="loginUsername" type="text" autocomplete="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required />
        </label>
        <label>
          <span>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</span>
          <div class="pass-wrap">
            <input id="loginPassword" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢" required />
            <button type="button" class="icon-btn" id="togglePass" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡">ğŸ‘ï¸</button>
          </div>
        </label>

        <button class="btn primary" type="submit">Ø¯Ø®ÙˆÙ„</button>
      </form>
    </section>
  </main>

  <!-- APP -->
  <div id="appView" class="app hidden">
    <header class="topbar">
      <div class="brand">
        <div class="vip-badge small">VIP</div>
        <div class="brand-text">
          <div class="title">Cashbook</div>
          <div class="subtitle" id="subtitleLine">Ø§Ù„Ø£Ø±ØµØ¯Ø©</div>
        </div>
      </div>

      <div class="top-actions">
        <button class="chip" id="themeBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">ğŸŒ“</button>
        <button class="chip" id="viewModeBtn" title="ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª">ğŸ“± Ø¹Ø±Ø¶</button>
        <button class="chip" id="exportBtn" title="ØªØµØ¯ÙŠØ± CSV">â¬‡ï¸ CSV</button>
        <button class="chip" id="printBtn" title="Ø·Ø¨Ø§Ø¹Ø©">ğŸ–¨ï¸</button>
        <button class="chip danger" id="logoutBtn" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬">Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <aside class="sidebar">
      <nav class="nav">
        <button class="nav-item active" data-view="dashboard"><span class="nav-ico">ğŸ“Š</span><span>Ø§Ù„Ø£Ø±ØµØ¯Ø©</span></button>
        <button class="nav-item" data-view="transactions"><span class="nav-ico">ğŸ§¾</span><span>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span></button>
        <button class="nav-item" data-view="accounts"><span class="nav-ico">ğŸ’¼</span><span>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</span></button>
        <button class="nav-item owner-only" data-view="users"><span class="nav-ico">ğŸ‘¥</span><span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span></button>

        <div class="nav-footer">
          <div class="pill">
            <div class="pill-title">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
            <div class="pill-value" id="currentUserName">â€”</div>
          </div>
          <div class="pill">
            <div class="pill-title">Ø§Ù„Ø¯ÙˆØ±</div>
            <div class="pill-value" id="currentUserRole">â€”</div>
          </div>
        </div>
      </nav>
    </aside>

    <main class="content">
      <!-- DASHBOARD (NO ADD/EDIT OPERATIONS HERE) -->
      <section id="view-dashboard" class="view">
        <div class="card">
          <div class="card-head">
            <h2>Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
            <div class="muted small" id="todayLabel">â€”</div>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª (Ø§Ù„ÙŠÙˆÙ…)</div>
              <div class="kpi-value" id="kpiIn">â€”</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Ø§Ù„ÙŠÙˆÙ…)</div>
              <div class="kpi-value" id="kpiOut">â€”</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">ØµØ§ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ© (Ø§Ù„ÙŠÙˆÙ…)</div>
              <div class="kpi-value" id="kpiNet">â€”</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="table-wrap">
            <table class="table" id="balancesTable">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª</th>
                  <th>Ù…Ø¯ÙÙˆØ¹Ø§Øª</th>
                  <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- TRANSACTIONS -->
      <section id="view-transactions" class="view hidden">
        <div class="card">
          <div class="card-head">
            <h2>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
            <div class="muted small">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®</div>
          </div>

          <div class="filters">
            <label><span>Ø§Ù„Ø­Ø³Ø§Ø¨</span><select id="fAccount"></select></label>
            <label><span>Ù…Ù†</span><input id="fFrom" type="date" /></label>
            <label><span>Ø¥Ù„Ù‰</span><input id="fTo" type="date" /></label>
            <label><span>Ø¨Ø­Ø«</span><input id="fSearch" type="text" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©" /></label>
            <button class="btn" id="clearFiltersBtn" type="button">Ù…Ø³Ø­</button>
          </div>

          <div class="divider"></div>

          <form id="txForm" class="form">
            <div class="row">
              <label class="grow"><span>Ø§Ù„Ø­Ø³Ø§Ø¨</span><select id="tAccount" required></select></label>
              <label class="grow"><span>Ø§Ù„Ù†ÙˆØ¹</span>
                <select id="tType" required>
                  <option value="in">Ù‚Ø¨Ø¶</option>
                  <option value="out">Ø¯ÙØ¹</option>
                </select>
              </label>
            </div>

            <div class="row">
              <label class="grow"><span>Ø§Ù„Ù…Ø¨Ù„Øº</span><input id="tAmount" type="number" min="0" step="0.01" placeholder="0" required /></label>
              <label class="grow"><span>Ø§Ù„ØªØ§Ø±ÙŠØ®</span><input id="tDate" type="date" required /></label>
            </div>

            <label><span>Ù…Ù„Ø§Ø­Ø¸Ø©</span><input id="tNote" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¥ÙŠØ¬Ø§Ø± / Ù…Ø¨ÙŠØ¹Ø§Øª / ØªØ­ÙˆÙŠÙ„" /></label>

            <button class="btn primary" type="submit">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
            <input type="hidden" id="editId" value="" />
          </form>

          <div class="divider"></div>

          <label class="btn" style="margin-bottom:10px;display:inline-block;">
            ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel
            <input type="file" id="importFile" accept=".xlsx,.csv" hidden>
          </label>

          <div class="table-wrap">
            <table class="table" id="txTable">
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="muted small" id="txCount">â€”</div>
        </div>
      </section>

      <!-- ACCOUNTS -->
      <section id="view-accounts" class="view hidden">
        <div class="card">
          <div class="card-head">
            <h2>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
            <div class="muted small">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨Ø§Øª</div>
          </div>

          <form id="accForm" class="form">
            <div class="row">
              <label class="grow"><span>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</span><input id="aName" type="text" placeholder="Ù…Ø«Ø§Ù„: ØµÙ†Ø¯ÙˆÙ‚" required /></label>
              <label class="grow"><span>Ø§Ù„Ù†ÙˆØ¹</span>
                <select id="aType" required>
                  <option value="cash">ØµÙ†Ø¯ÙˆÙ‚</option>
                  <option value="wallet">Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
                  <option value="insta">Ø­Ø³Ø§Ø¨ Ø§Ù†Ø³ØªØ§</option>
                  <option value="other">Ø£Ø®Ø±Ù‰</option>
                </select>
              </label>
            </div>

            <label><span>Ù…Ù„Ø§Ø­Ø¸Ø©</span><input id="aNote" type="text" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" /></label>

            <button class="btn primary" type="submit">Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
            <input type="hidden" id="aEditId" value="" />
          </form>

          <div class="divider"></div>

          <div class="table-wrap">
            <table class="table" id="accTable">
              <thead>
                <tr>
                  <th>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- USERS (ADMIN ONLY) -->
      <section id="view-users" class="view hidden">
        <div class="card">
          <div class="card-head">
            <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            <div class="muted small">Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·</div>
          </div>

          <form id="userForm" class="form">
            <div class="row">
              <label class="grow"><span>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span><input id="uUsername" type="text" placeholder="Ù…Ø«Ø§Ù„: user1" required /></label>
              <label class="grow"><span>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</span><input id="uPassword" type="text" placeholder="Ù…Ø«Ø§Ù„: 11111" required /></label>
            </div>
            <label><span>Ø§Ù„Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span><input id="uName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ahmed" /></label>
            <button class="btn primary" type="submit">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
          </form>

          <div class="divider"></div>

          <div class="table-wrap">
            <table class="table" id="usersTable">
              <thead>
                <tr>
                  <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ø¯ÙˆØ±</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="muted small">âš ï¸ Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ± Ø­Ø³Ø§Ø³Ø© (Static / Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±).</div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
/* VIP Cashbook - Ultimate stable build (GitHub Pages, no server)
   - Login (admin + local users)
   - Dashboard balances (NO add/edit operations)
   - Transactions CRUD + filters + Excel import
   - Accounts CRUD
   - Users page (admin only)
   - Mobile: top nav + tables as cards
*/

const OWNER = { username: "admin", password: "12345", role: "owner", name: "Admin" };

const LS_KEYS = {
  session: "vipUser",
  theme: "vipTheme",
  users: "vipUsers",
  accounts: "vipAccounts",
  tx: "vipTransactions",
  txView: "vipTxViewMode"
};

const el = (id) => document.getElementById(id);

function on(id, ev, fn){
  const node = document.getElementById(id);
  if (node) node.addEventListener(ev, fn);
  return node;
}


function normalizeDigits(str){
  // Convert Arabic-Indic and Eastern Arabic-Indic digits to Latin
  return String(str ?? "")
    .replace(/[Ù -Ù©]/g, d => String("Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)))
    .replace(/[Û°-Û¹]/g, d => String("Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)));
}

function toast(msg){
  const t = el("toast");
  if (!t) return;
  t.textContent = msg;
  t.classList.remove("hidden");
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.classList.add("hidden"), 2200);
}

function nowISODate(){
  const d = new Date();
  const off = d.getTimezoneOffset();
  const local = new Date(d.getTime() - off*60*1000);
  return local.toISOString().slice(0,10);
}

function fmtMoney(n){
  const x = Number(n || 0);
  return x.toLocaleString("ar-EG", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function safeParse(json, fallback){
  try{ return JSON.parse(json); }catch{ return fallback; }
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

function setRowLabels(tr, labels){
  const tds = tr.querySelectorAll("td");
  for(let i=0;i<tds.length && i<labels.length;i++){
    tds[i].setAttribute("data-label", labels[i]);
  }
}

/* ========= DATA ========= */
function getUsers(){ return safeParse(localStorage.getItem(LS_KEYS.users) || "[]", []); }
function saveUsers(users){ localStorage.setItem(LS_KEYS.users, JSON.stringify(users)); }

function seedAccountsIfEmpty(){
  const existing = safeParse(localStorage.getItem(LS_KEYS.accounts) || "null", null);
  if (Array.isArray(existing) && existing.length) return;
  const seed = [
    { id: crypto.randomUUID(), name: "ØµÙ†Ø¯ÙˆÙ‚", type: "cash", note: "" },
    { id: crypto.randomUUID(), name: "Vodafone Cash", type: "wallet", note: "" },
    { id: crypto.randomUUID(), name: "InstaPay", type: "wallet", note: "" },
    { id: crypto.randomUUID(), name: "Instagram 1", type: "insta", note: "" }
  ];
  localStorage.setItem(LS_KEYS.accounts, JSON.stringify(seed));
}

function getAccounts(){
  seedAccountsIfEmpty();
  return safeParse(localStorage.getItem(LS_KEYS.accounts) || "[]", []);
}
function saveAccounts(accs){ localStorage.setItem(LS_KEYS.accounts, JSON.stringify(accs)); }

function seedTxIfEmpty(){
  const existing = safeParse(localStorage.getItem(LS_KEYS.tx) || "null", null);
  if (Array.isArray(existing) && existing.length) return;
  const accs = getAccounts();
  const today = nowISODate();
  const seed = [
    { id: crypto.randomUUID(), date: today, accountId: accs[0].id, type: "in", amount: 1500, note: "Ù…Ø¨ÙŠØ¹Ø§Øª" }
  ];
  localStorage.setItem(LS_KEYS.tx, JSON.stringify(seed));
}

function getTx(){
  seedTxIfEmpty();
  return safeParse(localStorage.getItem(LS_KEYS.tx) || "[]", []);
}
function saveTx(list){ localStorage.setItem(LS_KEYS.tx, JSON.stringify(list)); }

/* ========= AUTH ========= */
function setSession(user){ localStorage.setItem(LS_KEYS.session, JSON.stringify(user)); }
function getSession(){ return safeParse(localStorage.getItem(LS_KEYS.session) || "null", null); }
function clearSession(){ localStorage.removeItem(LS_KEYS.session); }

function login(username, password){
  username = normalizeDigits(username).trim();
  password = normalizeDigits(password).trim();

  if (username === OWNER.username && password === OWNER.password){
    setSession(OWNER);
    return { ok:true, user: OWNER };
  }

  const users = getUsers();
  const user = users.find(u => u.username === username && u.password === password);
  if (!user) return { ok:false, error:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©" };

  setSession(user);
  return { ok:true, user };
}

function requireOwner(){
  const u = getSession();
  return !!(u && u.role === "owner");
}

/* ========= THEME ========= */
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(LS_KEYS.theme, theme);
}

function getTxViewMode(){
  return localStorage.getItem(LS_KEYS.txView) || "";
}
function setTxViewMode(mode){
  localStorage.setItem(LS_KEYS.txView, mode);
}
function applyTxViewMode(){
  // Default: cards on small screens, table on large screens
  const saved = getTxViewMode(); // 'table' or 'cards' or ''
  const isMobile = window.matchMedia("(max-width: 720px)").matches;
  let mode = saved;
  if (!mode){
    mode = isMobile ? "cards" : "table";
  }
  document.body.classList.toggle("tx-cards", mode === "cards");
  document.body.classList.toggle("tx-table", mode === "table");
  const btn = document.getElementById("viewModeBtn");
  if (btn){
    btn.textContent = mode === "cards" ? "ğŸ“‹ Ø¬Ø¯ÙˆÙ„" : "ğŸ“± Ø¨Ø·Ø§Ù‚Ø§Øª";
    btn.title = mode === "cards" ? "Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„" : "Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø§Øª";
  }
}
function toggleTxViewMode(){
  const cur = document.body.classList.contains("tx-cards") ? "cards" : "table";
  const next = cur === "cards" ? "table" : "cards";
  setTxViewMode(next);
  applyTxViewMode();
  // re-render to ensure labels exist
  if (typeof renderTransactions === "function") renderTransactions();
}

function toggleTheme(){
  const cur = localStorage.getItem(LS_KEYS.theme) || "dark";
  applyTheme(cur === "dark" ? "light" : "dark");
}

/* ========= UI ========= */
function showLogin(){
  el("loginView").classList.remove("hidden");
  el("appView").classList.add("hidden");
}
function showApp(){
  el("loginView").classList.add("hidden");
  el("appView").classList.remove("hidden");
  initAfterLogin();
}
function setSubtitle(text){ el("subtitleLine").textContent = text; }
function setActiveNav(view){
  document.querySelectorAll(".nav-item").forEach(b=>{
    b.classList.toggle("active", b.dataset.view === view);
  });
}
function showView(view){
  const views = ["dashboard","transactions","accounts","users"];
  for (const v of views){
    el(`view-${v}`).classList.toggle("hidden", v !== view);
  }
  const subMap = { dashboard:"Ø§Ù„Ø£Ø±ØµØ¯Ø©", transactions:"Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", accounts:"Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª", users:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†" };
  setSubtitle(subMap[view] || "");
  setActiveNav(view);

  if (view === "dashboard") renderDashboard();
  if (view === "transactions") renderTransactions();
  if (view === "accounts") renderAccounts();
  if (view === "users") renderUsers();
}

/* ========= CALCS ========= */
function accountLabel(type){
  const map = { cash:"ØµÙ†Ø¯ÙˆÙ‚", wallet:"Ù…Ø­ÙØ¸Ø©", insta:"Ø§Ù†Ø³ØªØ§", other:"Ø£Ø®Ø±Ù‰" };
  return map[type] || type;
}
function computeBalances(txList, accounts){
  const byAcc = new Map();
  for (const a of accounts) byAcc.set(a.id, { in:0, out:0, net:0 });
  for (const t of txList){
    const rec = byAcc.get(t.accountId) || { in:0, out:0, net:0 };
    const amt = Number(t.amount || 0);
    if (t.type === "in") rec.in += amt; else rec.out += amt;
    rec.net = rec.in - rec.out;
    byAcc.set(t.accountId, rec);
  }
  return byAcc;
}

function fillAccountSelect(selectEl, { includeAll=false } = {}){
  const current = selectEl.value;
  const accs = getAccounts();
  selectEl.innerHTML = "";
  if (includeAll){
    const op = document.createElement("option");
    op.value = "all";
    op.textContent = "ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª";
    selectEl.appendChild(op);
  }
  for (const a of accs){
    const op = document.createElement("option");
    op.value = a.id;
    op.textContent = `${a.name} â€¢ ${accountLabel(a.type)}`;
    selectEl.appendChild(op);
  }
  if (current) selectEl.value = current;
}
  for (const a of accs){
    const op = document.createElement("option");
    op.value = a.id;
    op.textContent = `${a.name} â€¢ ${accountLabel(a.type)}`;
    selectEl.appendChild(op);
  }
}

/* ========= FILTER ========= */
function filterTx(){
  const tx = getTx();
  const fAcc = el("fAccount").value;
  const from = el("fFrom").value;
  const to = el("fTo").value;
  const q = (el("fSearch").value || "").trim().toLowerCase();

  return tx.filter(t=>{
    if (fAcc && fAcc !== "all" && t.accountId !== fAcc) return false;
    if (from && t.date < from) return false;
    if (to && t.date > to) return false;
    if (q){
      const blob = `${t.note || ""}`.toLowerCase();
      if (!blob.includes(q)) return false;
    }
    return true;
  }).sort((a,b)=> (a.date === b.date ? (b.id.localeCompare(a.id)) : (b.date.localeCompare(a.date))));
}

/* ========= RENDER ========= */
function renderDashboard(){
  const today = nowISODate();
  el("todayLabel").textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…: ${today}`;

  const txToday = getTx().filter(t=> t.date === today);
  const totalIn = txToday.filter(t=>t.type==="in").reduce((s,t)=>s+Number(t.amount||0),0);
  const totalOut = txToday.filter(t=>t.type==="out").reduce((s,t)=>s+Number(t.amount||0),0);
  const net = totalIn - totalOut;

  el("kpiIn").textContent = fmtMoney(totalIn);
  el("kpiOut").textContent = fmtMoney(totalOut);
  el("kpiNet").textContent = fmtMoney(net);

  const accs = getAccounts();
  const byAcc = computeBalances(getTx(), accs);
  const tbody = el("balancesTable").querySelector("tbody");
  tbody.innerHTML = "";
  for (const a of accs){
    const b = byAcc.get(a.id) || { in:0, out:0, net:0 };
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${escapeHtml(a.name)}</strong></td>
      <td><span class="badge">${escapeHtml(accountLabel(a.type))}</span></td>
      <td>${fmtMoney(b.in)}</td>
      <td>${fmtMoney(b.out)}</td>
      <td><strong>${fmtMoney(b.net)}</strong></td>
    `;
    setRowLabels(tr, ["Ø§Ù„Ø­Ø³Ø§Ø¨","Ø§Ù„Ù†ÙˆØ¹","Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª","Ù…Ø¯ÙÙˆØ¹Ø§Øª","Ø§Ù„Ø±ØµÙŠØ¯"]);
    tbody.appendChild(tr);
  }
}

function renderTransactions(){
  fillAccountSelect(el("tAccount"));
  fillAccountSelect(el("fAccount"), { includeAll:true });

  const accs = getAccounts();
  const accById = new Map(accs.map(a=>[a.id,a]));

  const list = filterTx();
  const tbody = el("txTable").querySelector("tbody");
  tbody.innerHTML = "";

  for (const t of list){
    const a = accById.get(t.accountId);
    const accName = a ? `${a.name} â€¢ ${accountLabel(a.type)}` : "(Ù…Ø­Ø°ÙˆÙ)";
    const badge = t.type === "in" ? '<span class="badge in">Ù‚Ø¨Ø¶</span>' : '<span class="badge out">Ø¯ÙØ¹</span>';

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(t.date)}</td>
      <td>${escapeHtml(accName)}</td>
      <td>${badge}</td>
      <td><strong>${fmtMoney(t.amount)}</strong></td>
      <td>${escapeHtml(t.note || "")}</td>
      <td>
        <div class="actions">
          <button class="btn small ghost" data-act="edit" data-id="${t.id}">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn small danger ghost" data-act="del" data-id="${t.id}">Ø­Ø°Ù</button>
        </div>
      </td>
    `;
    setRowLabels(tr, ["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ø­Ø³Ø§Ø¨","Ø§Ù„Ù†ÙˆØ¹","Ø§Ù„Ù…Ø¨Ù„Øº","Ù…Ù„Ø§Ø­Ø¸Ø©","Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]);
    tbody.appendChild(tr);
  }
  el("txCount").textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${list.length}`;
}

function renderAccounts(){
  const accs = getAccounts();
  const tbody = el("accTable").querySelector("tbody");
  tbody.innerHTML = "";
  for (const a of accs){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${escapeHtml(a.name)}</strong></td>
      <td><span class="badge">${escapeHtml(accountLabel(a.type))}</span></td>
      <td>${escapeHtml(a.note || "")}</td>
      <td>
        <div class="actions">
          <button class="btn small ghost" data-act="editAcc" data-id="${a.id}">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn small danger ghost" data-act="delAcc" data-id="${a.id}">Ø­Ø°Ù</button>
        </div>
      </td>
    `;
    setRowLabels(tr, ["Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨","Ø§Ù„Ù†ÙˆØ¹","Ù…Ù„Ø§Ø­Ø¸Ø©","Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]);
    tbody.appendChild(tr);
  }
  el("aName").value = "";
  el("aType").value = "cash";
  el("aNote").value = "";
  el("aEditId").value = "";
}

function renderUsers(){
  if (!requireOwner()){
    toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    showView("dashboard");
    return;
  }
  const tbody = el("usersTable").querySelector("tbody");
  tbody.innerHTML = "";
  const users = getUsers();
  for (const u of users){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${escapeHtml(u.username)}</strong></td>
      <td>${escapeHtml(u.name || "")}</td>
      <td><span class="badge">${escapeHtml(u.role || "user")}</span></td>
      <td>
        <div class="actions">
          <button class="btn small danger ghost" data-act="delUser" data-username="${escapeAttr(u.username)}">Ø­Ø°Ù</button>
        </div>
      </td>
    `;
    setRowLabels(tr, ["Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…","Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ø¯ÙˆØ±","Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"]);
    tbody.appendChild(tr);
  }
  el("uUsername").value = "";
  el("uPassword").value = "";
  el("uName").value = "";
}

/* ========= MUTATIONS ========= */
function addTransaction({ accountId, type, amount, date, note }){
  const list = getTx();
  list.push({ id: crypto.randomUUID(), accountId, type, amount: Number(amount||0), date, note: note||"" });
  saveTx(list);
}
function updateTransaction(id, patch){
  const list = getTx();
  const idx = list.findIndex(t=>t.id===id);
  if (idx < 0) return false;
  list[idx] = { ...list[idx], ...patch };
  saveTx(list);
  return true;
}
function deleteTransaction(id){
  saveTx(getTx().filter(t=>t.id!==id));
}

function addAccount({ name, type, note }){
  const accs = getAccounts();
  accs.push({ id: crypto.randomUUID(), name, type, note: note||"" });
  saveAccounts(accs);
}
function updateAccount(id, patch){
  const accs = getAccounts();
  const idx = accs.findIndex(a=>a.id===id);
  if (idx < 0) return false;
  accs[idx] = { ...accs[idx], ...patch };
  saveAccounts(accs);
  return true;
}
function deleteAccount(id){
  saveAccounts(getAccounts().filter(a=>a.id!==id));
}

function addUser({ username, password, name }){
  const users = getUsers();
  if (users.find(u=>u.username===username)) return { ok:false, error:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„" };
  users.push({ username, password, name: name||"", role:"user" });
  saveUsers(users);
  return { ok:true };
}
function deleteUser(username){
  saveUsers(getUsers().filter(u=>u.username!==username));
}

/* ========= EXPORT / PRINT ========= */
function downloadText(filename, text){
  const blob = new Blob([text], { type:"text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function exportCSV(){
  const accs = getAccounts();
  const accById = new Map(accs.map(a=>[a.id,a]));
  const list = filterTx();
  const rows = [];
  rows.push(["date","account","account_type","type","amount","note","id"]);
  for (const t of list){
    const a = accById.get(t.accountId);
    rows.push([t.date, a?a.name:"(deleted)", a?accountLabel(a.type):"", t.type, String(Number(t.amount||0)), t.note||"", t.id]);
  }
  const csv = rows.map(r => r.map(cell=>{
    const s = String(cell ?? "");
    if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }).join(",")).join("\n");
  downloadText(`transactions_${nowISODate()}.csv`, csv);
  toast("ØªÙ… ØªØµØ¯ÙŠØ± CSV");
}
function printCurrent(){ window.print(); }

/* ========= EXCEL IMPORT ========= */
function handleImport(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(evt){
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    const accounts = getAccounts();

    let imported = 0;
    rows.forEach(r=>{
      const accName = String(r["Ø§Ù„Ø­Ø³Ø§Ø¨"] || "").trim();
      const acc = accounts.find(a => a.name.trim() === accName);
      if(!acc) return;

      const typRaw = String(r["Ø§Ù„Ù†ÙˆØ¹"] || "").trim();
      const type = (typRaw === "Ù‚Ø¨Ø¶" || typRaw.toLowerCase() === "in") ? "in" : "out";

      const date = String(r["Ø§Ù„ØªØ§Ø±ÙŠØ®"] || "").trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) return;

      addTransaction({
        accountId: acc.id,
        type,
        amount: parseFloat(r["Ø§Ù„Ù…Ø¨Ù„Øº"] || 0),
        date,
        note: String(r["Ù…Ù„Ø§Ø­Ø¸Ø©"] || "")
      });
      imported++;
    });

    renderDashboard();
    renderTransactions();
    alert(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­: ${imported}`);
    e.target.value = "";
  };
  reader.readAsArrayBuffer(file);
}

/* ========= INIT ========= */
function initAfterLogin(){
  const u = getSession();
  el("currentUserName").textContent = u?.name || u?.username || "â€”";
  el("currentUserRole").textContent = u?.role || "â€”";

  document.querySelectorAll(".owner-only").forEach(x=>{
    x.style.display = (u && u.role === "owner") ? "" : "none";
  });

  // set defaults
  el("tDate").value = nowISODate();
  el("fFrom").value = "";
  el("fTo").value = "";
  el("fSearch").value = "";

  showView("dashboard");
}

function wireEvents(){
  applyTheme(localStorage.getItem(LS_KEYS.theme) || "dark");
  on("themeBtn","click",toggleTheme);

  on("togglePass","click", ()=>{
    const p = el("loginPassword");
    p.type = (p.type === "password") ? "text" : "password";
  });

  on("loginForm","submit", (e)=>{
    e.preventDefault();
    const res = login(el("loginUsername").value, el("loginPassword").value);
    if (!res.ok){ toast(res.error); return; }
    toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
    showApp();
  });

  on("logoutBtn","click", ()=>{
    clearSession();
    toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
    setTimeout(()=>location.reload(), 250);
  });

  document.querySelectorAll(".nav-item").forEach(btn=>{
    btn.addEventListener("click", ()=> showView(btn.dataset.view));
  });

  // filters
  ["fAccount","fFrom","fTo","fSearch"].forEach(id=>{ const n = document.getElementById(id); if(n) n.addEventListener("input", renderTransactions); });
  on("clearFiltersBtn","click", ()=>{
    el("fAccount").value = "all";
    el("fFrom").value = "";
    el("fTo").value = "";
    el("fSearch").value = "";
    renderTransactions();
  });

  // tx form
  on("txForm","submit", (e)=>{
    e.preventDefault();
    const id = el("editId").value;
    const payload = {
      accountId: el("tAccount").value,
      type: el("tType").value,
      amount: Number(el("tAmount").value || 0),
      date: el("tDate").value,
      note: el("tNote").value
    };

    if (id){
      updateTransaction(id, payload);
      toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
    } else {
      addTransaction(payload);
      toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    }
    el("editId").value = "";
    el("tAmount").value = "";
    el("tNote").value = "";
    el("tDate").value = nowISODate();
    renderDashboard();
    renderTransactions();
  });

  on("txTable","click", (e)=>{
    const btn = e.target.closest("button");
    if (!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    if (!act || !id) return;

    if (act === "del"){
      if (!confirm("Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) return;
      deleteTransaction(id);
      toast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
      renderDashboard();
      renderTransactions();
      return;
    }
    if (act === "edit"){
      const tx = getTx().find(t=>t.id===id);
      if (!tx) return;
      el("editId").value = tx.id;
      el("tAccount").value = tx.accountId;
      el("tType").value = tx.type;
      el("tAmount").value = tx.amount;
      el("tDate").value = tx.date;
      el("tNote").value = tx.note || "";
      toast("ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
      showView("transactions");
    }
  });

  // accounts
  on("accForm","submit", (e)=>{
    e.preventDefault();
    const id = el("aEditId").value;
    const payload = { name: el("aName").value.trim(), type: el("aType").value, note: el("aNote").value.trim() };
    if (!payload.name) return toast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨");

    if (id){ updateAccount(id, payload); toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"); }
    else { addAccount(payload); toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); }

    renderAccounts();
    renderDashboard();
    renderTransactions();
  });

  on("accTable","click", (e)=>{
    const btn = e.target.closest("button");
    if (!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    if (!act || !id) return;

    if (act === "delAcc"){
      if (!confirm("Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ")) return;
      deleteAccount(id);
      toast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
      renderAccounts(); renderDashboard(); renderTransactions();
      return;
    }
    if (act === "editAcc"){
      const a = getAccounts().find(x=>x.id===id);
      if (!a) return;
      el("aEditId").value = a.id;
      el("aName").value = a.name;
      el("aType").value = a.type;
      el("aNote").value = a.note || "";
      toast("ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨");
      showView("accounts");
    }
  });

  // users (admin only)
  on("userForm","submit", (e)=>{
    e.preventDefault();
    if (!requireOwner()) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const username = normalizeDigits(el("uUsername").value.trim());
    const password = normalizeDigits(el("uPassword").value.trim());
    const name = el("uName").value.trim();
    if (!username || !password) return toast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    if (username === OWNER.username) return toast("Ù‡Ø°Ø§ Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ù…Ù†");

    const res = addUser({ username, password, name });
    if (!res.ok) return toast(res.error);
    toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
    renderUsers();
  });

  on("usersTable","click", (e)=>{
    const btn = e.target.closest("button");
    if (!btn) return;
    if (btn.dataset.act !== "delUser") return;
    if (!requireOwner()) return toast("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­");
    const username = btn.dataset.username;
    if (!confirm(`Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username}ØŸ`)) return;
    deleteUser(username);
    toast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
    renderUsers();
  });

  // export / print
  on("exportBtn","click",exportCSV);
  on("printBtn","click",printCurrent);

  // import
  const fileInput = el("importFile");
  if (fileInput) fileInput.addEventListener("change", handleImport);
}

function boot(){
  console.log("BOOT OK: VIP Cashbook loaded");
  wireEvents();
  const session = getSession();
  if (session) showApp();
  else showLogin();
}

document.addEventListener("DOMContentLoaded", boot);



</script>
</body>
</html>
